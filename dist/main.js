"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const config_1 = require("./config");
function exportCalendarToSpreadsheet() {
    try {
        const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
        const usageSheet = spreadsheet.getSheetByName('‰Ωø„ÅÑÊñπ');
        if (!usageSheet) {
            throw new Error('„Äå‰Ωø„ÅÑÊñπ„Äç„Ç∑„Éº„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
        }
        const startDateValue = usageSheet.getRange('B2').getValue();
        const endDateValue = usageSheet.getRange('B3').getValue();
        if (!startDateValue || !endDateValue) {
            throw new Error('‰Ωø„ÅÑÊñπ„Ç∑„Éº„Éà„ÅÆB2ÔºàÈñãÂßãÊó•Ôºâ„Åæ„Åü„ÅØB3ÔºàÁµÇ‰∫ÜÊó•Ôºâ„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
        }
        const startDate = new Date(startDateValue);
        startDate.setHours(0, 0, 0, 0);
        const endDate = new Date(endDateValue);
        endDate.setHours(23, 59, 59, 999);
        const calendar = CalendarApp.getCalendarById(config_1.CALENDAR_ID);
        let sheet = spreadsheet.getSheetByName("„Ç´„É¨„É≥„ÉÄ„Éº„Éá„Éº„Çø");
        if (!sheet) {
            sheet = spreadsheet.insertSheet("„Ç´„É¨„É≥„ÉÄ„Éº„Éá„Éº„Çø");
        }
        const lastRow = sheet.getMaxRows();
        if (lastRow > 0) {
            sheet.getRange(2, 1, lastRow, 5).clear();
        }
        sheet.getRange(1, 1, 1, 5).setValues([['Êó•‰ªò', 'ÈñãÂßãÊôÇÂàª', 'ÁµÇ‰∫ÜÊôÇÂàª', '„Çø„Ç§„Éà„É´', '„Ç≥„É°„É≥„Éà']]);
        const events = calendar.getEvents(startDate, endDate);
        if (events.length === 0) {
            sheet.getRange(2, 1).setValue('ÊåáÂÆöÊúüÈñì„Å´„Ç§„Éô„É≥„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì');
            console.log('ÊåáÂÆöÊúüÈñì„Å´„Ç§„Éô„É≥„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì');
            return;
        }
        const data = [];
        events.forEach(event => {
            const startTime = event.getStartTime();
            const endTime = event.getEndTime();
            data.push([
                Utilities.formatDate(startTime, 'JST', 'yyyy/M/d'),
                event.isAllDayEvent() ? 'ÁµÇÊó•' : Utilities.formatDate(startTime, 'JST', 'H:mm:ss'),
                event.isAllDayEvent() ? 'ÁµÇÊó•' : Utilities.formatDate(endTime, 'JST', 'H:mm:ss'),
                event.getTitle(),
                event.getDescription() || ''
            ]);
        });
        if (data.length > 0) {
            sheet.getRange(2, 1, data.length, 5).setValues(data);
        }
        console.log(`${events.length}‰ª∂„ÅÆ„Ç§„Éô„É≥„Éà„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü`);
        console.log(`„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà: ${spreadsheet.getName()}`);
        console.log(`„Ç∑„Éº„Éà: ${"„Ç´„É¨„É≥„ÉÄ„Éº„Éá„Éº„Çø"}`);
    }
    catch (error) {
        console.error('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü:', error);
        throw error;
    }
}
function exportCsvSheetToFile() {
    try {
        const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
        const csvSheet = spreadsheet.getSheetByName('csv');
        if (!csvSheet) {
            throw new Error('„Äåcsv„Äç„Ç∑„Éº„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
        }
        const lastRow = csvSheet.getLastRow();
        if (lastRow === 0) {
            console.log('csv„Ç∑„Éº„Éà„Å´„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
            return null;
        }
        const range = csvSheet.getRange(1, 1, lastRow, 14);
        const values = range.getValues();
        let csvContent = '';
        values.forEach((row, index) => {
            const csvRow = row.map((cell, colIndex) => {
                let cellValue = cell === null || cell === undefined ? '' : String(cell);
                if (colIndex <= 2 && cell instanceof Date) {
                    if (colIndex === 0) {
                        cellValue = Utilities.formatDate(cell, 'JST', 'yyyy/M/d');
                    }
                    else {
                        cellValue = Utilities.formatDate(cell, 'JST', 'H:mm:ss');
                    }
                }
                if (index > 0) {
                    cellValue = cellValue.replace(/"/g, '""');
                    cellValue = `"${cellValue}"`;
                }
                else {
                    if (cellValue.includes(',') || cellValue.includes('\n') || cellValue.includes('\r') || cellValue.includes('"')) {
                        cellValue = cellValue.replace(/"/g, '""');
                        cellValue = `"${cellValue}"`;
                    }
                }
                return cellValue;
            }).join(',');
            csvContent += csvRow;
            if (index < values.length - 1) {
                csvContent += '\n';
            }
        });
        const fileName = `export_${Utilities.formatDate(new Date(), 'JST', 'yyyyMMdd_HHmmss')}.csv`;
        const blob = Utilities.newBlob(csvContent, 'text/csv', fileName);
        const file = DriveApp.createFile(blob);
        console.log('===========================================');
        console.log(`CSV„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü: ${fileName}`);
        console.log(`„Éï„Ç°„Ç§„É´URL: ${file.getUrl()}`);
        console.log(`„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâURL: ${file.getDownloadUrl()}`);
        console.log('===========================================');
        console.log('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åô„Çã„Å´„ÅØ‰ª•‰∏ã„ÅÆURL„Çí„Éñ„É©„Ç¶„Ç∂„ÅßÈñã„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ:');
        console.log(file.getDownloadUrl());
        console.log('===========================================');
        console.log('‚Äª ÊñáÂ≠ó„Ç≥„Éº„Éâ: UTF-8');
        console.log('‚Äª Shift-JIS„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅØ„ÄÅ„É°„É¢Â∏≥„ÅßÈñã„ÅÑ„Å¶„ÄåANSI„ÄçÂΩ¢Âºè„Åß‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        const resultSheet = spreadsheet.getSheetByName('‰Ωø„ÅÑÊñπ');
        if (resultSheet) {
            resultSheet.getRange('B12').setValue(fileName);
            const richText = SpreadsheetApp.newRichTextValue()
                .setText('üì• „ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ')
                .setLinkUrl(file.getDownloadUrl())
                .build();
            resultSheet.getRange('B13').setRichTextValue(richText);
            resultSheet.getRange('B13').setFontColor('#1a73e8').setFontWeight('bold');
        }
        return {
            fileName: file.getName(),
            fileUrl: file.getUrl(),
            downloadUrl: file.getDownloadUrl()
        };
    }
    catch (error) {
        console.error('CSVÂá∫Âäõ„Ç®„É©„Éº:', error);
        throw error;
    }
}
function exportFacilityCalendarToPDF() {
    try {
        const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
        const spreadsheetId = spreadsheet.getId();
        const targetSheet = spreadsheet.getSheetByName('ÊñΩË®≠„Ç´„É¨„É≥„ÉÄ„Éº');
        if (!targetSheet) {
            throw new Error('„ÄåÊñΩË®≠„Ç´„É¨„É≥„ÉÄ„Éº„Äç„Ç∑„Éº„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
        }
        const sheetId = targetSheet.getSheetId();
        const params = {
            'format': 'pdf',
            'size': 'A4',
            'portrait': false,
            'fitw': true,
            'sheetnames': false,
            'printtitle': false,
            'pagenumbers': false,
            'gridlines': true,
            'fzr': false,
            'gid': sheetId,
            'r1': 0,
            'c1': 2,
            'r2': 24,
            'c2': 15
        };
        const queryString = Object.entries(params)
            .map(([key, value]) => `${key}=${value}`)
            .join('&');
        const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?${queryString}`;
        const response = UrlFetchApp.fetch(url, {
            headers: {
                'Authorization': 'Bearer ' + ScriptApp.getOAuthToken()
            }
        });
        const fileName = `ÊñΩË®≠„Ç´„É¨„É≥„ÉÄ„Éº_${Utilities.formatDate(new Date(), 'JST', 'yyyyMMdd_HHmmss')}.pdf`;
        const blob = response.getBlob().setName(fileName);
        const file = DriveApp.createFile(blob);
        console.log('===========================================');
        console.log(`PDF„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü: ${fileName}`);
        console.log(`ÁØÑÂõ≤: C1:P25ÔºàÊ®™Âêë„ÅçÔºâ`);
        console.log(`„Éï„Ç°„Ç§„É´URL: ${file.getUrl()}`);
        console.log(`„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâURL: ${file.getDownloadUrl()}`);
        console.log('===========================================');
        const usageSheet = spreadsheet.getSheetByName('‰Ωø„ÅÑÊñπ');
        if (usageSheet) {
            usageSheet.getRange('B15').setValue(fileName);
            const richText = SpreadsheetApp.newRichTextValue()
                .setText('üìÑ PDF„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ')
                .setLinkUrl(file.getDownloadUrl())
                .build();
            usageSheet.getRange('B16').setRichTextValue(richText);
            usageSheet.getRange('B16').setFontColor('#d93025').setFontWeight('bold');
        }
        return {
            fileName: file.getName(),
            fileUrl: file.getUrl(),
            downloadUrl: file.getDownloadUrl()
        };
    }
    catch (error) {
        console.error('PDFÂá∫Âäõ„Ç®„É©„Éº:', error);
        throw error;
    }
}
function exportSpreadsheetToPDF() {
    try {
        const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
        const spreadsheetId = spreadsheet.getId();
        const usageSheet = spreadsheet.getSheetByName('‰Ωø„ÅÑÊñπ');
        let sheetName = '„Ç´„É¨„É≥„ÉÄ„Éº„Éá„Éº„Çø';
        if (usageSheet) {
            const customSheetName = usageSheet.getRange('B5').getValue();
            if (customSheetName) {
                sheetName = customSheetName;
            }
        }
        const targetSheet = spreadsheet.getSheetByName(sheetName);
        if (!targetSheet) {
            throw new Error(`„Äå${sheetName}„Äç„Ç∑„Éº„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì`);
        }
        const sheetId = targetSheet.getSheetId();
        const params = {
            'format': 'pdf',
            'size': 'A4',
            'portrait': true,
            'fitw': true,
            'sheetnames': false,
            'printtitle': false,
            'pagenumbers': false,
            'gridlines': true,
            'fzr': false,
            'gid': sheetId
        };
        const queryString = Object.entries(params)
            .map(([key, value]) => `${key}=${value}`)
            .join('&');
        const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?${queryString}`;
        const response = UrlFetchApp.fetch(url, {
            headers: {
                'Authorization': 'Bearer ' + ScriptApp.getOAuthToken()
            }
        });
        const fileName = `${sheetName}_${Utilities.formatDate(new Date(), 'JST', 'yyyyMMdd_HHmmss')}.pdf`;
        const blob = response.getBlob().setName(fileName);
        const file = DriveApp.createFile(blob);
        console.log('===========================================');
        console.log(`PDF„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü: ${fileName}`);
        console.log(`„Éï„Ç°„Ç§„É´URL: ${file.getUrl()}`);
        console.log(`„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâURL: ${file.getDownloadUrl()}`);
        console.log('===========================================');
        if (usageSheet) {
            usageSheet.getRange('B17').setValue(fileName);
            const richText = SpreadsheetApp.newRichTextValue()
                .setText('üìÑ Ê±éÁî®PDF„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ')
                .setLinkUrl(file.getDownloadUrl())
                .build();
            usageSheet.getRange('B18').setRichTextValue(richText);
            usageSheet.getRange('B18').setFontColor('#188038').setFontWeight('bold');
        }
        return {
            fileName: file.getName(),
            fileUrl: file.getUrl(),
            downloadUrl: file.getDownloadUrl()
        };
    }
    catch (error) {
        console.error('PDFÂá∫Âäõ„Ç®„É©„Éº:', error);
        throw error;
    }
}
function executeAll() {
    try {
        console.log('===== Âá¶ÁêÜÈñãÂßã =====');
        console.log('1. „Ç´„É¨„É≥„ÉÄ„Éº„Éá„Éº„Çø„ÇíÂèñÂæó‰∏≠...');
        exportCalendarToSpreadsheet();
        console.log('2. CSV„Éï„Ç°„Ç§„É´„ÇíÁîüÊàê‰∏≠...');
        const csvResult = exportCsvSheetToFile();
        console.log('3. ÊñΩË®≠„Ç´„É¨„É≥„ÉÄ„ÉºPDF„Éï„Ç°„Ç§„É´„ÇíÁîüÊàê‰∏≠...');
        const facilityPdfResult = exportFacilityCalendarToPDF();
        console.log('4. Ê±éÁî®PDF„Éï„Ç°„Ç§„É´„ÇíÁîüÊàê‰∏≠...');
        const generalPdfResult = exportSpreadsheetToPDF();
        console.log('===== Âá¶ÁêÜÂÆå‰∫Ü =====');
        if (csvResult) {
            console.log('CSV„Éï„Ç°„Ç§„É´„ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâURL:');
            console.log(csvResult.downloadUrl);
        }
        console.log('ÊñΩË®≠„Ç´„É¨„É≥„ÉÄ„ÉºPDF„ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâURL:');
        console.log(facilityPdfResult.downloadUrl);
        console.log('Ê±éÁî®PDF„ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâURL:');
        console.log(generalPdfResult.downloadUrl);
        return {
            csv: csvResult,
            facilityPdf: facilityPdfResult,
            generalPdf: generalPdfResult
        };
    }
    catch (error) {
        console.error('‰∏ÄÊã¨ÂÆüË°å„Ç®„É©„Éº:', error);
        throw error;
    }
}
global.exportCalendarToSpreadsheet = exportCalendarToSpreadsheet;
global.exportCsvSheetToFile = exportCsvSheetToFile;
global.exportFacilityCalendarToPDF = exportFacilityCalendarToPDF;
global.exportSpreadsheetToPDF = exportSpreadsheetToPDF;
global.executeAll = executeAll;
