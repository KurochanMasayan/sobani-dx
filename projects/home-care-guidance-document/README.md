# 居宅療養管理指導書 自動作成（GAS）

## 概要

- Google スプレッドシート上の「居宅療養管理指導書」テンプレートに、CSV で渡される患者情報と月次カレンダーデータを差し込んでシートを自動生成する。
- 出力は患者ファイル内のシート作成まで。PDF 化や施設別集約、medical-guidance-system との連携は対象外。
- 実装は Google Apps Script（GAS）を前提とし、過剰な設計は行わない。
- テンプレートブック（同一スプレッドシート）内に「原本」「PatientFileRegistry」「GuidanceStatus」シートを配置し、テンプレート・URL管理・ログを一元管理する。

## 入力データ

| ファイル                     | パス                                                                     | 主な列                                                                                                                                                                                                                                                     | 利用目的                                                                                                                  |
| ---------------------------- | ------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------- |
| Ⅰ 患者情報\_居療管テスト.csv | `projects/home-care-guidance-document/Ⅰ 患者情報_居療管テスト.csv`       | `患者ID`, `患者名`, `生年月日`, `年齢`, `性別`, `郵便番号`, `住所`, `診断名`, `居宅介護支援事業所`, `寝たきり度`, `認知度`, `介護認定`, `日常生活や介護サービスを利用する上での留意点`, `定期訪問①（著変なし/変更あり）`, `定期訪問②（著変なし/変更あり）` | 文字コード `cp932`。①/② のラベルが付いているテンプレ項目は必ずこの CSV から取得する。`患者ID` が突合キー。                |
| Ⅱ calendar_data_YYYY-MM.csv  | `projects/home-care-guidance-document/Ⅱ calendar_data_2025-12.csv`（例） | `日付`, `開始時間`, `終了時間`, `医師名`, `orcaID`, `患者名`, `定期訪問`, `施設`, `訪問タイプ`                                                                                                                                                             | 1 訪問 = 1 行。`orcaID` = `患者ID`。`定期訪問` 列が「定期訪問」の行だけ採用し、往診・電話再診など他ステータスは除外する。 |

- CSV 上で ①/② や Ⅱ/Ⅲ が `�P` / `�U` などに文字化けしていても、スクリプト側で正しい文字に戻して処理する。

## データ突合と訪問判定

- カレンダー CSV は月単位で渡される。`orcaID` と患者 CSV の `患者ID` で患者情報を取得する。
- 同一患者がその月に 2 行まで登場する前提。2 件ある場合は日付の早い方を「定期訪問 ①」、遅い方を「定期訪問 ②」と扱う。
- 1 件しかない患者は「定期訪問 ①」のみ生成。3 件以上は想定外として処理をスキップまたはログに記録（追加仕様が入るまで自動生成しない）。
- シートを作成するのは `定期訪問` の行のみ。往診や電話再診が含まれていても無視してよい。

## 出力仕様

- **単位**: 患者ごとに 1 つの Spreadsheet ファイル。訪問日ごとにシートを追加（例: `2025-12-01_visit01`）。
- **テンプレ複製**: 初回はテンプレシート（`原本`）だけを新規スプレッドシートにコピーして患者ファイルを作成し、以降は同ファイル内でテンプレシートを複製して日付名にリネームする。ファイル名は `施設名-患者名`（各種禁止文字は `_` に置換）、シート名は訪問日（例: `2025-12-01`）。
- **URL レジストリ**: テンプレートと同じスプレッドシート内の `患者ファイル台帳` シートで管理。列構成は `orcaID`, `患者氏名`, `施設名`, `URL`, `最終更新`。GAS が患者ファイルを作成/更新するたびに自動で追記・更新する。
- **保存先**: Google Drive 上の専用フォルダ（`OUTPUT_FOLDER_ID` で指定）。PDF など二次出力は実施しない。
- **進行状況**: テンプレートスプレッドシート内に `進行管理` シートを自動作成し、直近の実行時刻・ステータス・今回処理人数・残り人数を表示。

## 実行方法（バッチ）

1. Drive 上で `PATIENT_CSV_FOLDER_ID` と `CALENDAR_CSV_FOLDER_ID` に最新 CSV を配置し、Script Properties に `OUTPUT_FOLDER_ID` も登録する。
2. テンプレートスプレッドシート（原本シート + `患者ファイル台帳` + `進行管理`）を開き、メニュー「居療管指導書」→「指導書生成（開始）」を押す。初回実行時にレジストリと処理キュー（`GUIDANCE_PENDING_QUEUE`）が自動初期化される。
3. GAS が 6 分以内で処理できる人数ずつ自動で進み、未完了分は内部キューに残して 1 分後の時間トリガー（`continueGuidanceGeneration`）で続行する。手動で再度ボタンを押す必要はないが、中断したい場合のみメニューから再開を指示する。
4. `GuidanceStatus` シートでステータスが「完了」になったら当月分の処理が終了。不要になった CSV はフォルダから削除する。

## GAS ファイル構成
- `gas/main.gs`: onOpen/開始/継続のエントリーポイントとバッチ制御ロジック。
- `gas/config.gs`: Script Properties の読み取りや `BASE_CONFIG` の定義（シート名は「原本」「患者ファイル台帳」「進行管理」を使用）。
- `gas/data-loaders.gs`: CSV 読み込みと患者/訪問データの整形。
- `gas/template.gs`: 原本シートの複製、患者ファイル生成、セルへの値差し込み。
- `gas/registry.gs`: `PatientFileRegistry` シートの取得・更新。
- `gas/status.gs`: `GuidanceStatus` シートの作成とステータス表示。
- `gas/queue.gs`: 残処理キューと時間トリガーの管理。
- `gas/utils.gs`: ログ出力や日付/文字列ユーティリティ。

## GAS 処理手順

1. Script Properties に `PATIENT_CSV_FOLDER_ID`・`CALENDAR_CSV_FOLDER_ID`・`OUTPUT_FOLDER_ID` を設定。初回実行時に `REGISTRY_SPREADSHEET_ID`（URL レジストリ）と `GUIDANCE_PENDING_QUEUE`（未処理患者キュー）が自動生成される。
2. `DriveApp` で 2 つの CSV を取得し、`cp932` で読み込む。患者 CSV は `患者ID` をキーに Map 化。
3. カレンダー CSV から `定期訪問` の行だけを残し、患者 ID ごとに訪問日昇順でグループ化。各月に 2 件超があれば警告ログを残し、その患者の処理をスキップ。
4. 各訪問レコードに「定期訪問 ①/②」ラベルを割り当てる。若い日付が ①、もう一方が ②。
5. キューから取り出した患者について、レジストリで既存ファイルを確認し、無ければテンプレブックから複製して登録。
6. テンプレシートを複製し、シート名を訪問日 + 連番に設定。
7. 下記マッピングに従って `getRange().setValue()` で値を流し込み、指定のない欄は空欄のままにする。
8. 5 分程度処理したら一旦終了し、残キューは `GUIDANCE_PENDING_QUEUE` に保存。時間トリガー（`continueGuidanceGeneration`）を自動登録して続きから処理する。

## 症状・経過（22〜24 行）の扱い

- 画像上で 22〜24 行に該当する枠は「症状・経過」欄。
- 入力順序は訪問 ① → 訪問 ②。月内で若い日付が ①、遅い日付が ②。
- 各訪問ごとに、まず `定期訪問①/②（変更あり）` を確認し、内容がある場合はそれを採用。空欄であれば `（著変なし）` の文面を使用する。
- 現行テンプレートでは B33 のみを使用するため、② の内容があっても出力対象は定期訪問①の欄のみ（②は今後拡張時に対応）。

## テンプレ項目マッピング

| セル位置 | 入力値 | 取得元 |
| --- | --- | --- |
| R2 | 訪問日の `Utilities.formatDate()` | カレンダー `日付` |
| H4 | `居宅介護支援事業所` | 患者 CSV |
| G7 | `患者名` | 患者 CSV |
| T7 | `性別` | 患者 CSV |
| G8 | `生年月日`（和暦 → 西暦へ正規化） | 患者 CSV |
| R8 | `年齢` | 患者 CSV |
| H9 | `郵便番号`（`〒` 付与） | 患者 CSV |
| G10 | `住所` | 患者 CSV |
| F11 | `日付` | カレンダー CSV |
| F13 | `診断名`（改行維持） | 患者 CSV |
| C22 | `定期訪問①/②` のコメント（変更あり→著変なし優先） | 患者 CSV |
| G29 | `介護認定` | 患者 CSV |
| G30 | `寝たきり度` | 患者 CSV |
| G31 | `認知度` | 患者 CSV |
| B33 | `日常生活や介護サービスを利用する上での留意点` | 患者 CSV |

※ 画像で ①/② の番号が付いていない欄は記入不要。`御担当ケアマネージャー` など CSV に存在しない情報は空欄維持。

## 未確定事項 / 今後決めること

- 患者ファイル保存先フォルダ ID（`OUTPUT_FOLDER_ID`）を本番 Drive で確定させる。
- 同日に定期訪問が 2 件以上ある場合の命名ルール（`visit02` の扱い）。
- 3 件以上の定期訪問レコードが混入した際の正式な処理方針（現在は自動スキップ）。
- ケアマネ氏名・備考など追加で必要な列をどこから取得するか。

上記がそろい次第、GAS 実装に着手できる。必要になった情報は本 README に追記する。
