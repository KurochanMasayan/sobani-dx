# 居宅療養管理指導書 自動作成（GAS）

## 概要

- Google スプレッドシート上の「居宅療養管理指導書」テンプレートに、CSV で渡される患者情報と月次カレンダーデータを差し込んでシートを自動生成する。
- 出力は事業所別スプレッドシート内のシート作成まで。PDF 化や medical-guidance-system との連携は対象外。
- 実装は Google Apps Script（GAS）を前提とし、過剰な設計は行わない。
- テンプレートブック（同一スプレッドシート）内に「原本」「事業所ファイル台帳」「進行管理」「処理キュー」シートを配置し、テンプレート・URL管理・ログ・キュー管理を一元管理する。

## 入力データ

| ファイル                     | パス                                                                     | 主な列                                                                                                                                                                                                                                                     | 利用目的                                                                                                                  |
| ---------------------------- | ------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------- |
| Ⅰ 患者情報\_居療管テスト.csv | `projects/home-care-guidance-document/Ⅰ 患者情報_居療管テスト.csv`       | `患者ID`, `患者名`, `生年月日`, `年齢`, `性別`, `郵便番号`, `住所`, `診断名`, `居宅介護支援事業所`, `寝たきり度`, `認知度`, `介護認定`, `日常生活や介護サービスを利用する上での留意点`, `定期訪問①（著変なし/変更あり）`, `定期訪問②（著変なし/変更あり）` | 文字コード `cp932`。①/② のラベルが付いているテンプレ項目は必ずこの CSV から取得する。`患者ID` が突合キー。                |
| Ⅱ calendar_data_YYYY-MM.csv  | `projects/home-care-guidance-document/Ⅱ calendar_data_2025-12.csv`（例） | `日付`, `開始時間`, `終了時間`, `医師名`, `orcaID`, `患者名`, `定期訪問`, `施設`, `訪問タイプ`                                                                                                                                                             | 1 訪問 = 1 行。`orcaID` = `患者ID`。`定期訪問` 列が「定期訪問」の行だけ採用し、往診・電話再診など他ステータスは除外する。 |

- CSV 上で ①/② や Ⅱ/Ⅲ が `�P` / `�U` などに文字化けしていても、スクリプト側で正しい文字に戻して処理する。

## データ突合と訪問判定

- カレンダー CSV は月単位で渡される。`orcaID` と患者 CSV の `患者ID` で患者情報を取得する。
- 同一患者がその月に 2 行まで登場する前提。2 件ある場合は日付の早い方を「定期訪問 ①」、遅い方を「定期訪問 ②」と扱う。
- 1 件しかない患者は「定期訪問 ①」のみ生成。3 件以上は想定外として処理をスキップまたはログに記録（追加仕様が入るまで自動生成しない）。
- シートを作成するのは `定期訪問` の行のみ。往診や電話再診が含まれていても無視してよい。

## 出力仕様

- **単位**: 居宅支援事業所ごと・年月ごとに 1 つの Spreadsheet ファイル。患者ごとにシートを追加（例: `患者名_2025-12-01`）。
- **施設ソート**: 処理開始時にキューを施設名でソートし、同じ施設の患者が連続して処理されるようにする。これにより、同一施設のスプレッドシートへの書き込みが効率化される。
- **実行ID管理**: 1回の実行を識別する実行ID（例: `2025-12-20T10:30:00_a1b2c3d4`）を生成し、6分制限による中断・再開時に同じスプレッドシートに追記できるようにする。
- **テンプレ複製**: 施設ファイルがなければテンプレシート（`原本`）から新規スプレッドシートを作成。以降は同ファイル内でテンプレシートを複製して患者名+日付名にリネームする。
- **フォルダ構成**: 出力フォルダ配下に実行日時フォルダ（例: `2025-12-20-103000`）を作成し、その中に施設名.xlsx を配置する。
- **事業所ファイル台帳**: テンプレートと同じスプレッドシート内の `事業所ファイル台帳` シートで管理。列構成は `年月`, `居宅支援事業所名`, `URL`, `実行ID`, `フォルダID`, `最終更新`。同一バッチ内で同じ施設のスプレッドシートを再利用する。
- **保存先**: Google Drive 上の専用フォルダ（`OUTPUT_FOLDER_ID` で指定）配下の実行日時フォルダ。PDF など二次出力は実施しない。
- **進行状況**: テンプレートスプレッドシート内に `進行管理` シートを自動作成し、直近の実行時刻・ステータス・今回処理人数・残り人数を表示。
- **処理キュー**: テンプレートスプレッドシート内に `処理キュー` シートを自動作成し、処理対象の患者ID・施設名・ステータスを可視化する。

## 実行方法（バッチ）

1. Drive 上で `PATIENT_CSV_FOLDER_ID` と `CALENDAR_CSV_FOLDER_ID` に最新 CSV を配置し、Script Properties に `OUTPUT_FOLDER_ID` も登録する。
2. テンプレートスプレッドシート（原本シート + `事業所ファイル台帳` + `進行管理`）を開き、メニュー「居療管指導書」→「指導書生成（開始）」を押す。初回実行時に `処理キュー` シートが自動作成される。
3. GAS が 5 分以内で処理できる人数ずつ自動で進み、未完了分は `処理キュー` シートに残して 1 分後の時間トリガー（`continueGuidanceGeneration`）で続行する。手動で再度ボタンを押す必要はないが、中断したい場合のみメニューから再開を指示する。
4. `進行管理` シートでステータスが「完了」になったら当月分の処理が終了。不要になった CSV はフォルダから自動削除される。

## GAS ファイル構成

- `gas/main.gs`: onOpen/開始/継続のエントリーポイントとバッチ制御ロジック。施設ソート・実行ID管理を含む。
- `gas/config.gs`: Script Properties の読み取りや `BASE_CONFIG` の定義（シート名は「原本」「事業所ファイル台帳」「進行管理」「処理キュー」「訪問選択」を使用）。
- `gas/data-loaders.gs`: CSV 読み込みと患者/訪問データの整形。3件以上の訪問がある患者を分離。
- `gas/template.gs`: 原本シートの複製、事業所別スプレッドシート生成、セルへの値差し込み、実行フォルダ管理。
- `gas/registry.gs`: `事業所ファイル台帳` シートの取得・更新（年月+施設名+実行IDで検索）。
- `gas/status.gs`: `進行管理` シートの作成とステータス表示。
- `gas/queue.gs`: `処理キュー` シートの管理、残処理キュー、時間トリガー、実行ID・年月の保存。
- `gas/visit-selection.gs`: `訪問選択` シートの管理。3件以上訪問がある患者の訪問回選択UI。
- `gas/utils.gs`: ログ出力や日付/文字列ユーティリティ、施設ソート関数。

## GAS 処理手順

1. Script Properties に `PATIENT_CSV_FOLDER_ID`・`CALENDAR_CSV_FOLDER_ID`・`OUTPUT_FOLDER_ID` を設定。
2. `DriveApp` で 2 つの CSV を取得し、`cp932` で読み込む。患者 CSV は `患者ID` をキーに Map 化。
3. カレンダー CSV から `定期訪問` の行だけを残し、患者 ID ごとに訪問日昇順でグループ化。各月に 2 件超があれば警告ログを残し、その患者の処理をスキップ。
4. 各訪問レコードに「定期訪問 ①/②」ラベルを割り当てる。若い日付が ①、もう一方が ②。
5. 処理キューを施設名でソートし、実行ID・年月を生成・保存。`処理キュー` シートに患者ID・施設名・ステータスを記録。
6. キューから取り出した患者について、事業所ファイル台帳で既存ファイルを確認（年月+施設名+実行IDで検索）。なければ実行フォルダ内に新規スプレッドシートを作成して登録。
7. テンプレシートを複製し、シート名を患者名+訪問日に設定。
8. 下記マッピングに従って `getRange().setValue()` で値を流し込み、指定のない欄は空欄のままにする。
9. 5 分経過したら一旦終了し、`処理キュー` シートの処理済み患者を「処理済み」にマーク。時間トリガー（`continueGuidanceGeneration`）を自動登録して続きから処理する。

## 症状・経過（22〜24 行）の扱い

- 画像上で 22〜24 行に該当する枠は「症状・経過」欄。
- 入力順序は訪問 ① → 訪問 ②。月内で若い日付が ①、遅い日付が ②。
- 各訪問ごとに、まず `定期訪問①/②（変更あり）` を確認し、内容がある場合はそれを採用。空欄であれば `（著変なし）` の文面を使用する。
- 現行テンプレートでは B33 のみを使用するため、② の内容があっても出力対象は定期訪問①の欄のみ（②は今後拡張時に対応）。

## テンプレ項目マッピング

| セル位置 | 入力値 | 取得元 |
| --- | --- | --- |
| R2 | 訪問日の `Utilities.formatDate()` | カレンダー `日付` |
| H4 | `居宅介護支援事業所` | 患者 CSV |
| G7 | `患者名` | 患者 CSV |
| T7 | `性別` | 患者 CSV |
| G8 | `生年月日`（和暦 → 西暦へ正規化） | 患者 CSV |
| R8 | `年齢` | 患者 CSV |
| H9 | `郵便番号`（`〒` 付与） | 患者 CSV |
| G10 | `住所` | 患者 CSV |
| F11 | `日付` | カレンダー CSV |
| F13 | `診断名`（改行維持） | 患者 CSV |
| C22 | `定期訪問①/②` のコメント（変更あり→著変なし優先） | 患者 CSV |
| G29 | `介護認定` | 患者 CSV |
| G30 | `寝たきり度` | 患者 CSV |
| G31 | `認知度` | 患者 CSV |
| B33 | `日常生活や介護サービスを利用する上での留意点` | 患者 CSV |

※ 画像で ①/② の番号が付いていない欄は記入不要。`御担当ケアマネージャー` など CSV に存在しない情報は空欄維持。

## 事業所ファイル台帳の列構成

| 列 | 内容 | 説明 |
| --- | --- | --- |
| A | 年月 | 処理対象の年月（例: 2025-12） |
| B | 居宅支援事業所名 | 正規化された施設名（「（在）」等の接頭辞を除去） |
| C | URL | スプレッドシートのURL |
| D | 実行ID | バッチ実行を識別するID（6分制限対応） |
| E | フォルダID | 出力先フォルダのID（再開時に同じフォルダを使用） |
| F | 最終更新 | 最終更新日時 |

## 処理キューシートの列構成

| 列 | 内容 | 説明 |
| --- | --- | --- |
| A | 順番 | 処理順序（施設名でソート済み） |
| B | 患者ID | 患者ID（6桁ゼロパディング） |
| C | 施設名 | 居宅支援事業所名 |
| D | ステータス | 「待機」または「処理済み」 |

## 3件以上の訪問がある患者の処理

月内に3件以上の定期訪問がある患者については、どの訪問回を書類①②に使用するか選択が必要。

### 処理フロー

1. 「指導書生成（開始）」を実行すると、2件以下の患者は自動処理され、3件以上の患者は「訪問選択」シートに登録される。
2. 「訪問選択」シートで各患者の「書類①に使用する回」「書類②に使用する回」をプルダウンから選択。
3. メニュー「居療管指導書」→「選択患者を処理」を実行して選択した患者を処理。

### デフォルト設定

- **全3回の場合**: 1回目と2回目を使用
- **全4回の場合**: 1回目と3回目を使用

### 訪問選択シートの列構成

| 列 | 内容 | 説明 |
| --- | --- | --- |
| A | 患者ID | 患者ID（6桁ゼロパディング） |
| B | 患者名 | 患者名 |
| C | 施設名 | 居宅支援事業所名 |
| D | 訪問回数 | 月内の定期訪問回数（3以上） |
| E | 訪問日一覧 | 各訪問の日付一覧 |
| F | 書類①に使用する回 | プルダウンで選択（1回目〜N回目） |
| G | 書類②に使用する回 | プルダウンで選択（1回目〜N回目） |
| H | ステータス | 「未処理」または「処理済み」 |

## 未確定事項 / 今後決めること

- 患者ファイル保存先フォルダ ID（`OUTPUT_FOLDER_ID`）を本番 Drive で確定させる。
- 同日に定期訪問が 2 件以上ある場合の命名ルール（`visit02` の扱い）。
- ケアマネ氏名・備考など追加で必要な列をどこから取得するか。

上記がそろい次第、GAS 実装に着手できる。必要になった情報は本 README に追記する。
