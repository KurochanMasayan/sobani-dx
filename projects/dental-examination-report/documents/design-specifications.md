# 歯科検診報告書 設計仕様書

## 1. システム構成

### 1.1 アーキテクチャ
```
┌─────────────────────────────────┐
│     Google Sheets Interface     │
├─────────────────────────────────┤
│    Google Apps Script (GAS)     │
├─────────────────────────────────┤
│      Data Storage (Sheets)      │
└─────────────────────────────────┘
```

### 1.2 使用技術
- **フロントエンド**: Google Sheets UI
- **バックエンド**: Google Apps Script
- **データストレージ**: Google Sheets
- **スタイリング**: 条件付き書式

## 2. 画面設計

### 2.1 メインシート構成

#### レイアウト構造
```
行1-3:   ヘッダー情報（タイトル、患者情報）
行4-5:   凡例（色の説明）
行6-7:   空白行（視覚的な区切り）
行8-12:  上顎歯科チャート
行13-14: 中央区切り線
行15-19: 下顎歯科チャート
行20-21: 空白行
行22-26: 統計情報
行27-30: 備考欄
```

### 2.2 歯科チャート詳細設計

#### セル配置（U字型レイアウト）
```
【上顎】
        右側                    左側
   E    F    G    H    I    J    K    L    (列)
8  [18] [17] [16] [15] [14] [13] [12] [11] (歯番号)
9  [○] [○] [○] [○] [○] [○] [○] [○] (状態)

10                                         (空白)

11 [○] [○] [○] [○] [○] [○] [○] [○] (状態)
12 [21] [22] [23] [24] [25] [26] [27] [28] (歯番号)

【下顎】
15 [48] [47] [46] [45] [44] [43] [42] [41] (歯番号)
16 [○] [○] [○] [○] [○] [○] [○] [○] (状態)

17                                         (空白)

18 [○] [○] [○] [○] [○] [○] [○] [○] (状態)
19 [31] [32] [33] [34] [35] [36] [37] [38] (歯番号)
```

### 2.3 セル仕様

#### サイズ設定
- **列幅**: 40ピクセル
- **行高**: 40ピクセル
- **フォントサイズ**:
  - 歯番号: 10pt
  - 状態記号: 16pt

#### 罫線設定
- **外枠**: 太線（2pt）
- **内部**: 細線（1pt）
- **区切り線**: 二重線

## 3. 状態管理設計

### 3.1 状態定義

| 状態コード | 表示 | 意味 | 背景色 | 文字色 |
|-----------|------|------|--------|--------|
| 0 | ○ | 健全歯 | #FFFFFF | #000000 |
| 1 | C | 虫歯 | #FF4444 | #FFFFFF |
| 2 | × | 欠損 | #333333 | #FFFFFF |
| 3 | ✓ | 治療済 | #4444FF | #FFFFFF |
| 4 | CO | 要観察 | #FFCC00 | #000000 |

### 3.2 データ入力規則

#### ドロップダウンリスト設定
```javascript
// データ検証ルール
const validationRule = SpreadsheetApp.newDataValidation()
  .requireValueInList(['○', 'C', '×', '✓', 'CO'])
  .setAllowInvalid(false)
  .setHelpText('歯の状態を選択してください')
  .build();
```

### 3.3 条件付き書式ルール

```javascript
// 各状態に対する書式設定
const formatRules = [
  {value: '○', background: '#FFFFFF', color: '#000000'},
  {value: 'C', background: '#FF4444', color: '#FFFFFF'},
  {value: '×', background: '#333333', color: '#FFFFFF'},
  {value: '✓', background: '#4444FF', color: '#FFFFFF'},
  {value: 'CO', background: '#FFCC00', color: '#000000'}
];
```

## 4. 機能仕様

### 4.1 患者情報入力部

```
B2: 患者名: [_____________]
B3: 年齢: [___] 歳
F2: 検診日: [____/___/___]
F3: 担当医: [_____________]
```

### 4.2 統計表示部

```
B22: === 検診結果統計 ===
B23: 健全歯: [自動計算] 本
B24: 虫歯:   [自動計算] 本
B25: 欠損:   [自動計算] 本
B26: 治療済: [自動計算] 本
```

#### 計算式
```javascript
// 健全歯数の計算例
=COUNTIF(E9:L9, "○") + COUNTIF(E11:L11, "○") +
 COUNTIF(E16:L16, "○") + COUNTIF(E18:L18, "○")
```

### 4.3 操作補助機能

#### ボタン配置
- **位置**: M8
- **機能**:
  - 「全て健全に設定」
  - 「選択範囲をクリア」
  - 「前回データ読込」

#### キーボードショートカット（GAS実装）
- `1`: 健全歯に設定
- `2`: 虫歯に設定
- `3`: 欠損に設定
- `4`: 治療済に設定
- `5`: 要観察に設定

## 5. GAS機能実装

### 5.1 初期化機能
```javascript
function initializeDentalChart() {
  // シートの初期設定
  // セルサイズ調整
  // 書式設定
  // データ検証ルール適用
}
```

### 5.2 一括操作機能
```javascript
function bulkUpdateTeeth(range, status) {
  // 選択範囲の一括更新
  // 履歴記録
  // 統計更新
}
```

### 5.3 データ保存機能
```javascript
function savePatientData() {
  // 患者データの保存
  // タイムスタンプ記録
  // バックアップ作成
}
```

## 6. データモデル

### 6.1 患者データ構造
```javascript
{
  patientId: "string",
  patientName: "string",
  age: number,
  examinationDate: "date",
  doctor: "string",
  teethStatus: {
    upper: {
      right: [18, 17, 16, 15, 14, 13, 12, 11],
      left: [21, 22, 23, 24, 25, 26, 27, 28]
    },
    lower: {
      right: [48, 47, 46, 45, 44, 43, 42, 41],
      left: [31, 32, 33, 34, 35, 36, 37, 38]
    }
  },
  statistics: {
    healthy: number,
    cavity: number,
    missing: number,
    treated: number,
    observation: number
  }
}
```

## 7. ユーザーインターフェース詳細

### 7.1 視覚的強化要素

#### 歯のグループ化
- 前歯部（切歯・犬歯）: 薄い青の背景
- 臼歯部: 薄いグレーの背景

#### アイコン使用
```
🦷 健全歯（絵文字対応環境）
⚠️ 要注意マーカー
✅ 完了マーカー
```

### 7.2 レスポンシブ対応
- 最小画面幅: 1024px
- 印刷時の自動調整
- ズーム機能対応

## 8. エラー処理

### 8.1 入力検証
- 不正な値の拒否
- 範囲外の歯番号チェック
- 必須項目の確認

### 8.2 エラーメッセージ
```javascript
const errorMessages = {
  invalidInput: "無効な入力です",
  requiredField: "必須項目です",
  saveError: "保存に失敗しました"
};
```

## 9. パフォーマンス最適化

### 9.1 処理の効率化
- バッチ処理の使用
- キャッシュの活用
- 不要な再計算の抑制

### 9.2 応答性の向上
- 非同期処理の活用
- プログレスバー表示
- 段階的な表示更新

## 10. セキュリティ対策

### 10.1 アクセス制御
- Googleアカウント認証
- 編集権限の管理
- 閲覧専用モード

### 10.2 データ保護
- 自動バックアップ
- 変更履歴の記録
- 復元機能