# 配布記録から在庫変動履歴への連携実装ガイド

## 課題

配布記録の作成方法が複数存在するため、form savedイベントだけでは不十分：
- **フォーム入力**: form savedイベントが発火する ✓
- **テンプレートからのアクション作成**: form savedイベントが発火しない ✗
- **API経由**: form savedイベントが発火しない ✗

## 推奨解決策: Automationボットによる統一管理

### 実装方法

#### 1. Automationボットの作成

**Bot名**: `Auto_Create_Inventory_History`

**イベント設定**:
```
Event Type: Data Change
Table: 配布記録
Event: ADDS (新規追加時)
Condition: TRUE (すべての新規配布記録)
```

**プロセス設定**:

##### Step 1: 在庫変動履歴の作成
```
Action Type: Add a row
Table: 在庫変動履歴
Set these columns:
  - 変動日: [_THISROW].[配布日]
  - 商品ID: [_THISROW].[商品ID]
  - 変動区分: "配布"
  - 変動数量_個: -[_THISROW].[配布数量]
  - 施設ID: [_THISROW].[施設ID]
  - 患者ID: [_THISROW].[患者ID]
  - 配布ID: [_THISROW].[配布ID]
  - 変動理由: CONCATENATE(
      IF(ISNOTBLANK([_THISROW].[患者ID]),
        "個別配布",
        "施設配布"
      ),
      " - ",
      [_THISROW].[備考]
    )
  - 記録者: [_THISROW].[配布者]
```

##### Step 2: 在庫数量の更新
```
Action Type: Update row
Table: 在庫管理
Row to update:
  FILTER(
    "在庫管理",
    [商品ID] = [_THISROW].[商品ID]
  )
Set these columns:
  - 現在庫_個: [現在庫_個] - [_THISROW].[配布数量]
  - 最終更新日: NOW()
```

##### Step 3: 箱から個への自動補充（条件付き）
```
Condition:
  AND(
    [現在庫_個] < 0,
    [現在庫_箱] > 0
  )

Action:
  - 現在庫_箱: [現在庫_箱] - 1
  - 現在庫_個: [現在庫_個] + [商品ID].[箱入数]
```

### メリット

1. **統一性**: どの経路から配布記録が作成されても確実に連携
2. **保守性**: 一箇所で管理、変更が容易
3. **拡張性**: 条件分岐やエラー処理を追加可能
4. **監査性**: すべての在庫変動が記録される

## 代替案（非推奨）

### 案1: グループアクション方式

テンプレートからの作成時に、配布記録作成と在庫変動履歴作成を連続実行。

**問題点**:
- フォーム入力時は別途form savedが必要（二重管理）
- アクションごとに同じ処理を実装する必要がある

### 案2: Referenced Action方式

配布記録作成アクション内で、在庫変動履歴も同時作成。

**問題点**:
- 複雑になりエラー処理が困難
- トランザクション管理ができない

## エラーハンドリング

### 在庫不足時の処理

Automationボットに条件を追加：

```
Step 2の前に条件チェック:
IF(
  [在庫管理].[現在庫_個] >= [_THISROW].[配布数量],
  "続行",
  "通知＆エラーログ"
)
```

### 通知設定

```
Action Type: Send notification
To: [_THISROW].[配布者]
Subject: "在庫不足警告"
Body: CONCATENATE(
  "商品: ", [商品ID].[商品名],
  " の在庫が不足しています。",
  "必要数: ", [配布数量],
  "現在庫: ", [在庫管理].[現在庫_個]
)
```

## 実装手順

1. **Automation作成**
   - AppSheetエディタで「Automation」タブを開く
   - 新規ボット作成
   - イベント設定（配布記録のADDS）
   - プロセス設定（在庫変動履歴作成＋在庫更新）

2. **テスト**
   - フォームから配布記録作成 → 在庫変動確認
   - テンプレートから一括作成 → 在庫変動確認
   - 在庫不足ケースのテスト

3. **既存form savedアクションの削除**
   - 重複を避けるため、既存のform savedアクションを削除

## 注意事項

- Automationは非同期処理のため、即座には反映されない（数秒の遅延）
- 大量処理時はキューイングされる
- エラー時はログで確認可能（Monitor > Automation）

## まとめ

Automationボットを使用することで、配布記録の作成経路に関わらず、確実に在庫変動履歴への連携と在庫数量の更新が実現できます。これにより、システム全体の整合性と保守性が向上します。