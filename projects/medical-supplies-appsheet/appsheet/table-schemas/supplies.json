{
  "tableName": "商品マスタ",
  "displayName": "商品マスタ",
  "description": "医療機器・医療材料の基本情報を管理するマスタテーブル",
  "columns": [
    {
      "name": "supply_id",
      "type": "Text",
      "displayName": "医材ID",
      "required": true,
      "key": true,
      "initialValue": "CONCATENATE(\"SUP\", TEXT(ROW(), \"000\"))",
      "editable": false,
      "description": "医材の一意識別子"
    },
    {
      "name": "supply_name",
      "type": "Text",
      "displayName": "医材名",
      "required": true,
      "searchable": true,
      "description": "医材の正式名称"
    },
    {
      "name": "pieces_per_box",
      "type": "Number",
      "displayName": "箱入数",
      "required": true,
      "initialValue": "1",
      "description": "1箱あたりの個数"
    },
    {
      "name": "unit",
      "type": "Text",
      "displayName": "単位",
      "required": true,
      "description": "数量の単位（箱、個、本など）"
    },
    {
      "name": "supplier_id",
      "type": "Text",
      "displayName": "発注先ID",
      "required": true,
      "description": "主要な発注先ID"
    },
    {
      "name": "shelf_number",
      "type": "Text",
      "displayName": "棚番号",
      "required": false,
      "description": "標準的な保管棚番号"
    },
    {
      "name": "shelf_level",
      "type": "Text",
      "displayName": "段数",
      "required": false,
      "description": "標準的な保管段数"
    },
    {
      "name": "fixed_stock_flag",
      "type": "Boolean",
      "displayName": "定数在庫フラグ",
      "required": false,
      "initialValue": "FALSE",
      "description": "定数在庫管理対象かどうか"
    },
    {
      "name": "fixed_stock_boxes",
      "type": "Number",
      "displayName": "定数在庫(箱)",
      "required": false,
      "initialValue": "0",
      "description": "定数在庫の箱数"
    },
    {
      "name": "created_at",
      "type": "DateTime",
      "displayName": "作成日時",
      "required": true,
      "initialValue": "NOW()",
      "editable": false,
      "description": "レコード作成日時"
    }
  ],
  "virtualColumns": [
    {
      "name": "total_stock_pieces",
      "type": "Number",
      "displayName": "在庫合計個数",
      "formula": "SUM(SELECT(在庫管理[total_stock_pieces], [supply_id] = [_THISROW].[supply_id]))",
      "description": "在庫管理テーブルから集計した総個数"
    },
    {
      "name": "current_stock_boxes",
      "type": "Number",
      "displayName": "現在在庫(箱)",
      "formula": "LET( total := [total_stock_pieces], perBox := IF([pieces_per_box] > 0, [pieces_per_box], 1), FLOOR(total / perBox) )",
      "description": "在庫合計個数を箱単位に換算した値"
    },
    {
      "name": "current_stock_pieces",
      "type": "Number",
      "displayName": "現在在庫(個)",
      "formula": "LET( total := [total_stock_pieces], perBox := IF([pieces_per_box] > 0, [pieces_per_box], 1), total - (FLOOR(total / perBox) * perBox) )",
      "description": "箱換算後に残る端数個数。負数の場合は箱から借りて正の値に調整"
    },
    {
      "name": "pending_orders",
      "type": "Number",
      "displayName": "発注中数量",
      "formula": "SUM(SELECT(発注管理[order_quantity_boxes], AND([supply_id] = [_THISROW].[supply_id], IN([status], {\"申請中\", \"承認済\", \"発注済\", \"一部入荷\"}))))",
      "description": "発注中の数量（箱単位）"
    }
  ],
  "security": {
    "readPermission": "ROLE_USER",
    "writePermission": "ROLE_ADMIN",
    "deletePermission": "ROLE_ADMIN"
  },
  "formatting": {
    "summaryColumn": "supply_name",
    "sortBy": "supply_name"
  }
}
