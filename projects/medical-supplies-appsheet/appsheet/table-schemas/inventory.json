{
  "tableName": "在庫管理",
  "displayName": "在庫管理",
  "description": "医材の在庫状況をロット単位で管理するテーブル",
  "columns": [
    {
      "name": "inventory_id",
      "type": "Text",
      "displayName": "在庫ID",
      "required": true,
      "key": true,
      "initialValue": "CONCATENATE(\"INV\", TEXT(ROW(), \"000\"))",
      "editable": false,
      "description": "在庫レコードの一意識別子"
    },
    {
      "name": "supply_id",
      "type": "Ref",
      "displayName": "医材ID",
      "required": true,
      "referencedTable": "商品マスタ",
      "referencedColumn": "supply_id",
      "description": "商品マスタへの参照"
    },
    {
      "name": "stock_boxes",
      "type": "Number",
      "displayName": "在庫箱数",
      "required": true,
      "initialValue": "0",
      "description": "実在する在庫の箱数"
    },
    {
      "name": "stock_pieces",
      "type": "Number",
      "displayName": "在庫個数",
      "required": false,
      "initialValue": "0",
      "description": "箱に満たない端数の在庫個数"
    },
    {
      "name": "allocated_boxes",
      "type": "Number",
      "displayName": "引当済在庫(箱)",
      "required": false,
      "initialValue": "0",
      "description": "予約済みの在庫箱数"
    },
    {
      "name": "available_boxes",
      "type": "Number",
      "displayName": "利用可能在庫(箱)",
      "required": true,
      "formula": "[stock_boxes] - [allocated_boxes]",
      "description": "利用可能な在庫箱数"
    },
    {
      "name": "lot_number",
      "type": "Text",
      "displayName": "ロット番号",
      "required": false,
      "description": "製造ロット番号"
    },
    {
      "name": "expiry_date",
      "type": "Date",
      "displayName": "有効期限",
      "required": false,
      "description": "有効期限（該当する場合）"
    },
    {
      "name": "location",
      "type": "Text",
      "displayName": "保管場所",
      "required": false,
      "description": "具体的な保管場所"
    },
    {
      "name": "last_updated",
      "type": "DateTime",
      "displayName": "最終更新日時",
      "required": true,
      "resetOnEdit": "NOW()",
      "description": "在庫情報の最終更新日時"
    },
    {
      "name": "updated_by",
      "type": "Text",
      "displayName": "更新者",
      "required": true,
      "initialValue": "USEREMAIL()",
      "resetOnEdit": "USEREMAIL()",
      "description": "在庫情報を更新したユーザー"
    }
  ],
  "virtualColumns": [
    {
      "name": "supply_name",
      "type": "Text",
      "displayName": "医材名",
      "formula": "LOOKUP([supply_id], \"商品マスタ\", \"supply_id\", \"supply_name\")",
      "description": "商品マスタから取得する医材名"
    },
    {
      "name": "unit",
      "type": "Text",
      "displayName": "単位",
      "formula": "LOOKUP([supply_id], \"商品マスタ\", \"supply_id\", \"unit\")",
      "description": "商品マスタから取得する単位"
    },
    {
      "name": "pieces_per_box",
      "type": "Number",
      "displayName": "箱入数",
      "formula": "LOOKUP([supply_id], \"商品マスタ\", \"supply_id\", \"pieces_per_box\")",
      "description": "1箱あたりの個数"
    },
    {
      "name": "total_stock_pieces",
      "type": "Number",
      "displayName": "在庫合計個数",
      "formula": "([stock_boxes] * [pieces_per_box]) + [stock_pieces]",
      "description": "箱数と端数を合わせた総個数"
    },
    {
      "name": "days_to_expiry",
      "type": "Number",
      "displayName": "期限までの日数",
      "formula": "IF(ISBLANK([expiry_date]), \"\", [expiry_date] - TODAY())",
      "description": "有効期限までの残り日数"
    },
    {
      "name": "expiry_status",
      "type": "Text",
      "displayName": "期限ステータス",
      "formula": "IF(ISBLANK([expiry_date]), \"期限なし\", IF([days_to_expiry] < 0, \"期限切れ\", IF([days_to_expiry] <= 30, \"期限間近\", \"正常\")))",
      "description": "有効期限の状況判定"
    }
  ],
  "validationRules": [
    {
      "condition": "[stock_boxes] >= 0",
      "message": "在庫箱数は0以上である必要があります"
    },
    {
      "condition": "[stock_pieces] >= 0",
      "message": "在庫個数は0以上である必要があります"
    },
    {
      "condition": "[allocated_boxes] >= 0",
      "message": "引当済在庫は0以上である必要があります"
    },
    {
      "condition": "[allocated_boxes] <= [stock_boxes]",
      "message": "引当済在庫は在庫箱数を超えることはできません"
    }
  ],
  "security": {
    "readPermission": "ROLE_USER",
    "writePermission": "ROLE_MANAGER",
    "deletePermission": "ROLE_ADMIN"
  },
  "formatting": {
    "summaryColumn": "supply_name",
    "sortBy": "supply_name"
  },
  "filters": [
    {
      "name": "active_stock",
      "condition": "OR([stock_boxes] > 0, [stock_pieces] > 0)",
      "description": "在庫のある医材のみ表示"
    },
    {
      "name": "expiring_soon",
      "condition": "AND(NOT(ISBLANK([expiry_date])), [days_to_expiry] <= 30, [days_to_expiry] >= 0)",
      "description": "30日以内に期限切れになる医材のみ表示"
    }
  ]
}
