# 施設マスタ (facilities)

## テーブル概要
- **テーブル名**: facilities
- **説明**: 訪問診療を行う施設の基本情報を管理
- **主キー**: 施設ID

## カラム定義

| カラム名 | 物理名 | データ型 | 必須 | 列種別 | 説明 |
|---------|--------|----------|------|--------|------|
| 施設ID | facility_id | Text | ✓ | 物理 | 一意識別子（faci-XXX形式） |
| 施設名 | facility_name | Text | ✓ | 物理 | 施設の正式名称 |
| 施設タイプ | facility_type | Enum | ✓ | 物理 | 施設/在宅/個人宅 |
| 住所 | address | Text | | 物理 | 施設の所在地 |
| 電話番号 | phone | Phone | | 物理 | 連絡先電話番号 |
| 担当者 | contact_person | Text | | 物理 | 施設側担当者名 |
| 配布週 | distribution_week | Number | | 物理 | 配布する週（第N週：1-4） |
| 配布曜日 | distribution_day | Enum | | 物理 | 配布する曜日（月-日） |
| 患者数 | patient_count | Number | | 仮想 | 所属患者数（計算式: COUNT([Related patients]）） |
| 前回配布日 | last_distribution_date | Date | | 仮想 | 直近の過去配布日（計算式参照） |
| 次回配布日 | next_distribution_date | Date | | 仮想 | 次回予定配布日（計算式参照） |

## 施設タイプの選択肢
- 施設
- 在宅
- 個人宅

## 配布曜日の選択肢
- 月曜日
- 火曜日
- 水曜日
- 木曜日
- 金曜日
- 土曜日
- 日曜日

## AppSheet設定
- **ラベル**: 施設名
- **キー**: 施設ID
- **表示順**: 施設タイプ → 施設名
- **計算式**:
  - 前回配布日 = MAX(SELECT(箱マスタ[配布日], AND(IN([箱ID], SELECT(箱詰記録[箱ID], [施設ID] = [_THISROW].[施設ID])), [配布日] <= TODAY()), TRUE))
  - 次回配布日 = IF(AND(ISNOTBLANK([配布週]), ISNOTBLANK([配布曜日])), IF((EOMONTH(TODAY(), -1) + 1 + MOD(SWITCH([配布曜日], "月曜日", 2, "火曜日", 3, "水曜日", 4, "木曜日", 5, "金曜日", 6, "土曜日", 7, "日曜日", 1, 2) - WEEKDAY(EOMONTH(TODAY(), -1) + 1) + 7, 7) + ([配布週] - 1) * 7) > TODAY(), EOMONTH(TODAY(), -1) + 1 + MOD(SWITCH([配布曜日], "月曜日", 2, "火曜日", 3, "水曜日", 4, "木曜日", 5, "金曜日", 6, "土曜日", 7, "日曜日", 1, 2) - WEEKDAY(EOMONTH(TODAY(), -1) + 1) + 7, 7) + ([配布週] - 1) * 7, EOMONTH(TODAY(), 0) + 1 + MOD(SWITCH([配布曜日], "月曜日", 2, "火曜日", 3, "水曜日", 4, "木曜日", 5, "金曜日", 6, "土曜日", 7, "日曜日", 1, 2) - WEEKDAY(EOMONTH(TODAY(), 0) + 1) + 7, 7) + ([配布週] - 1) * 7), "")
- **バリデーション**:
  - 配布週は1〜4の範囲