# 入荷記録

## テーブル概要
- **テーブル名**: 入荷記録
- **説明**: 発注レコードに紐づく入荷情報（分割入荷対応）を記録
- **主キー**: 入荷ID

## カラム定義

| カラム名 | 物理名 | データ型 | 必須 | 列種別 | 説明 |
|---------|--------|----------|------|--------|------|
| 入荷ID | receipt_id | UniqueID | ✓ | 物理 | 一意識別子（自動生成） |
| 発注ID | order_id | Ref | ✓ | 物理 | 紐づく発注（発注記録参照、IsPartOf = TRUE） |
| 入荷日 | delivery_date | Date | ✓ | 物理 | 入荷日 |
| 入荷箱数 | received_boxes_input | Number | ✓ | 物理 | 入荷箱数（入力用） |
| 入荷個数 | received_pieces | Number | ✓ | 物理 | 入荷個数（自動計算された値を保存） |
| ロット番号 | lot_number | Text |  | 物理 | 入荷ロット番号（任意） |
| 検品者 | inspected_by | Email |  | 物理 | 入荷検品担当者 |
| 備考 | notes | Text |  | 物理 | 特記事項 |
| 作成日時 | created_at | DateTime | ✓ | 物理 | レコード作成日時 |
| 商品ID | product_id | Ref | | 仮想 | 発注レコードから取得（計算式: [発注ID].[商品ID]） |
| 商品名 | product_name | Text | | 仮想 | 商品名（計算式: [発注ID].[商品名]） |
| 箱入数 | pieces_per_box | Number | | 仮想 | 箱入数（計算式: [商品ID].[箱入数]） |
| 入荷箱数_表示 | received_boxes_display | Number | | 仮想 | 入荷箱数表示（計算式: FLOOR([入荷個数] / [箱入数])） |
| 発注個数 | order_quantity_pieces | Number | | 仮想 | 発注個数（計算式: [発注ID].[発注個数]） |
| 残個数 | remaining_pieces | Number | | 仮想 | 入荷後の残個数（計算式: [発注ID].[発注個数] - SUM([発注ID].[関連入荷].[入荷個数])） |

## AppSheet設定
- **ラベル**: CONCATENATE([発注ID], "-", [入荷日])
- **キー**: 入荷ID
- **IsPartOf**: 発注記録テーブルの [関連入荷] に対して TRUE
- **初期値**:
  - 入荷日 = TODAY()
  - 作成日時 = NOW()
  - 検品者 = USEREMAIL()
- **計算式**:
  - 入荷個数 = [入荷箱数] * [商品ID].[箱入数]
  - 商品ID = [発注ID].[商品ID]
  - 商品名 = [発注ID].[商品名]
  - 発注個数 = [発注ID].[発注個数]
- **アクション**:
  - 追加時に 商品マスタ[現在在庫個数] を入荷個数分加算
  - 在庫変動履歴に「入荷」として記録
  - 発注ステータス更新（SUM入荷個数に応じて 発注記録[状態] を変更）
- **条件付き書式**:
  - 残個数 = 0 → 緑背景（入荷完了）
  - 残個数 > 0 → オレンジ背景（未完了）

## ビュー例
- 発注詳細ビュー内の入荷サブテーブル（テーブルビュー）
- 入荷履歴ビュー（デッキビュー）

## 注意事項
- 同一発注に複数入荷レコードを登録可能（分割入荷対応）
- 入荷個数の合計が発注個数を超えないようバリデーションを設定
- 入荷は箱単位で入力し、個数に自動変換して保存
- 入荷キャンセル時は記録を削除するのではなく備考に理由を残す運用を想定
