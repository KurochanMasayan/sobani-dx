# 臨時配布記録

## テーブル概要
- **テーブル名**: 臨時配布記録
- **説明**: 臨時配布の依頼・準備を管理する中間テーブル
- **主キー**: 臨時配布ID
- **役割**: セットテンプレートから配布記録への橋渡し、臨時配布の一括管理

## カラム定義

| カラム名 | 物理名 | データ型 | 必須 | 列種別 | 説明 |
|---------|--------|----------|------|--------|------|
| 臨時配布ID | emergency_distribution_id | Text | ✓ | 物理 | 一意識別子（EMD-XXX形式） |
| 依頼日 | request_date | Date | ✓ | 物理 | 臨時配布依頼日（デフォルト: TODAY()） |
| テンプレート使用 | use_template | Yes/No | ✓ | 物理 | セットテンプレート使用フラグ（デフォルト: TRUE） |
| セットID | set_template_id | Ref | | 物理 | 使用するセットテンプレート（テンプレート使用時のみ必須） |
| 施設ID | facility_id | Ref | | 物理 | 配布先施設（任意） |
| 患者ID | patient_id | Ref | | 物理 | 対象患者（任意） |
| 商品ID | product_id | Ref | | 物理 | 配布する単体商品（単体配布時のみ必須） |
| 配布数量 | quantity | Number | ✓ | 物理 | セット倍数または単体商品個数（デフォルト: 1） |
| 配布理由 | distribution_reason | Enum | ✓ | 物理 | 緊急処置/追加処置/その他 |
| ステータス | status | Enum | ✓ | 物理 | 準備中/配布済み/キャンセル |
| 配布者 | distributed_by | Email | | 物理 | 実際の配布実施者 |
| 配布実施日 | distributed_date | Date | | 物理 | 実際の配布日 |
| 備考 | notes | LongText | | 物理 | 配布理由詳細・特記事項 |
| 作成日時 | created_at | DateTime | ✓ | 物理 | レコード作成日時 |
| セット名 | set_name | Text | | 仮想 | セット名（計算式: [セットID].[セット名]） |
| 患者名 | patient_name | Text | | 仮想 | 患者名（計算式: IF(ISNOTBLANK([患者ID]), [患者ID].[フルネーム], "")） |
| 施設名 | facility_name | Text | | 仮想 | 施設名（計算式: IF(ISNOTBLANK([施設ID]), [施設ID].[施設名], "")） |
| 構成商品数 | component_count | Number | | 仮想 | セット構成商品数（計算式: COUNT(SELECT(セット構成明細[構成ID], [セットID] = [_THISROW].[セットID]))） |
| 総配布予定数 | total_planned_quantity | Number | | 仮想 | 総配布予定個数（計算式: SUM(SELECT(セット構成明細[標準数量], [セットID] = [_THISROW].[セットID])) * [配布倍数]） |
| 配布済み数量 | distributed_quantity | Number | | 仮想 | 実際の配布数量（計算式: ABS(SUM(SELECT(在庫変動履歴[変動数量], [関連ID] = [_THISROW].[臨時配布ID])))） |
| 臨時配布ラベル | emergency_label | Text | | 仮想 | 表示用ラベル（計算式: CONCATENATE(TEXT([依頼日]), " ", [患者名], " - ", [セット名])） |

## AppSheet設定
- **ラベル**: [臨時配布ラベル]
- **キー**: 臨時配布ID
- **リレーション**:
  - セットID → セットテンプレートマスタ.set_template_id
  - 患者ID → 患者マスタ.patient_id
  - 施設ID → 施設マスタ.facility_id
  - 在庫変動履歴 ← 関連ID
- **初期値**:
  - 依頼日 = TODAY()
  - 配布倍数 = 1
  - ステータス = "準備中"
  - 作成日時 = NOW()
- **計算式**:
  - セット名 = [セットID].[セット名]
  - 患者名 = IF(ISNOTBLANK([患者ID]), [患者ID].[フルネーム], "")
  - 施設名 = IF(ISNOTBLANK([施設ID]), [施設ID].[施設名], "")
  - 構成商品数 = COUNT(SELECT(セット構成明細[構成ID], [セットID] = [_THISROW].[セットID]))
  - 総配布予定数 = SUM(SELECT(セット構成明細[標準数量], [セットID] = [_THISROW].[セットID])) * [配布倍数]
  - 配布済み数量 = ABS(SUM(SELECT(在庫変動履歴[変動数量], [関連ID] = [_THISROW].[臨時配布ID])))
  - 臨時配布ラベル = CONCATENATE(TEXT([依頼日]), " ", [患者名], " - ", [セット名])
- **バリデーション**:
  - 配布倍数 > 0
- **条件付き書式**:
  - ステータス = "キャンセル" → グレーアウト
  - ステータス = "配布済み" → 緑色背景
  - 配布理由 = "緊急処置" → 赤色文字
- **並び順**: 依頼日 DESC, 作成日時 DESC

## Enum定義
- **配布理由**: 緊急処置, 追加処置, 定期外処置, その他
- **ステータス**: 準備中, 配布済み, キャンセル

## ビジネスルール
1. 臨時配布の依頼から実施までを一元管理
2. セットテンプレートの構成商品を在庫変動履歴に一括展開
3. 配布倍数により「×2消費処理」に対応
4. ステータス「配布済み」時に在庫変動履歴を自動生成
5. 一度配布済みになった記録の編集は制限
6. キャンセル時の在庫調整は在庫変動履歴削除により自動実施

## アクション設計
1. **配布実行アクション**:
   - 前提条件: ステータス = "準備中"
   - 在庫チェック: 全構成商品の在庫充足性を確認
   - 在庫変動履歴生成: セット構成明細を参照して一括生成
     - 各構成商品ごとに在庫変動履歴を作成
     - 変動個数 = -(標準数量 × 配布倍数)
     - 取引タイプ = "臨時配布"
     - 関連ID = [臨時配布記録].[臨時配布ID]
     - 関連テーブル = "臨時配布記録"
   - 商品マスタ在庫更新: 各構成商品の現在在庫個数を自動減算
   - ステータス更新: "準備中" → "配布済み"
   - 配布実施日・配布者を設定

2. **在庫チェックアクション**:
   - セット構成明細の必須商品をループ処理
   - 各商品の現在在庫 >= (標準数量 × 配布倍数) をチェック
   - 在庫不足時はエラーメッセージで実行ブロック
   - 非必須商品は警告のみ表示

3. **キャンセルアクション**:
   - 前提条件: ステータス = "準備中" または "配布済み"
   - 配布済みの場合: 関連する在庫変動履歴を削除
   - 商品マスタ在庫復元: 在庫変動履歴削除により自動復元
   - ステータス更新: "キャンセル"

4. **編集制限アクション**:
   - ステータス = "配布済み" の場合、主要フィールドの編集を禁止
   - 備考のみ編集可能とする

## 他テーブルとの関係
- **セットテンプレートマスタ**: 多対1の関係（臨時配布→セット）
- **患者マスタ**: 多対1の関係（臨時配布→患者）
- **施設マスタ**: 多対1の関係（臨時配布→施設）
- **在庫変動履歴**: 1対多の関係（臨時配布→在庫変動）
- **セット構成明細**: 参照関係（在庫変動履歴生成時に使用）

## ビュー例
- 臨時配布依頼一覧ビュー（テーブルビュー）
- 本日の臨時配布ビュー（カードビュー）
- ステータス別臨時配布ビュー（ステータスでグループ化）
- セット別臨時配布実績ビュー（セットIDでグループ化）
- 緊急配布一覧ビュー（配布理由フィルタ）
- 配布待ち一覧ビュー（ステータス = "準備中"）

## ワークフロー例
1. 臨時配布が必要になる
2. セットテンプレートを選択（点滴セット、抗生剤セット等）
3. 患者・施設・配布理由を入力
4. 配布倍数を設定（通常1、×2処理の場合は2）
5. 「準備中」で保存
6. 在庫状況を確認
7. 配布実行→在庫変動履歴を一括生成→在庫から自動減算
8. ステータス「配布済み」に更新

## レポート機能
- 臨時配布集計レポート（月次・週次）
- セット別使用頻度分析
- 緊急配布状況レポート
- 配布理由別統計分析