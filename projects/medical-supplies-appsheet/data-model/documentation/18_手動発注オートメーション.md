# 手動発注オートメーション

## 概要

手動発注リクエストテーブルへのレコード追加をトリガーに、商品マスタの手動発注カラムを更新するオートメーション設定。

## 前提: 値の受け渡しについて

AppSheetのオートメーションでは、「Run a data action」タスクで別テーブルのアクションを実行する際、**アクションは対象テーブル（商品マスタ）のコンテキストで評価される**。そのため、トリガー元（手動発注リクエスト）の値を直接参照することはできない。

### 解決策

商品マスタに仮想カラムを追加し、手動発注リクエストの値を参照する。アクションではその仮想カラムの値を物理カラムにコピーする。

## 商品マスタに追加する仮想カラム

| カラム名 | 計算式 |
|---------|--------|
| _最新手動発注数量_箱 | `ANY(SELECT(手動発注リクエスト[手動発注数量_箱], [商品ID] = [_THISROW].[商品ID]))` |

※ アンダースコアで始まる名前は、内部処理用であることを示す命名規則

## Bot設定

### Bot 1: 手動発注リクエスト追加時

```yaml
Bot Name: 手動発注_商品マスタ更新
Event:
  Type: Data change
  Table: 手動発注リクエスト
  Data change type: Adds only

Process:
  Step 1:
    Type: Run a data action
    Table: 商品マスタ
    Referenced Rows: LIST([商品ID])
    Action: 商品マスタ_手動発注設定
```

### Action: 商品マスタ_手動発注設定

```yaml
Action Name: 商品マスタ_手動発注設定
Action Type: Data - Set row values
Target Table: 商品マスタ

Set these columns:
  手動発注追加フラグ: TRUE
  手動発注数量_箱: [_最新手動発注数量_箱]
```

※ `[_最新手動発注数量_箱]` は商品マスタの仮想カラム。手動発注リクエストから最新の値を取得している。

## 発注実行後のリセット

発注記録が作成された後、手動発注カラムをリセットする。

### Bot 2: 発注後_手動フラグリセット

```yaml
Bot Name: 発注後_手動フラグリセット
Event:
  Type: Data change
  Table: 発注記録
  Data change type: Adds only

Process:
  Step 1:
    Type: Run a data action
    Table: 商品マスタ
    Referenced Rows: LIST([商品ID])
    Action: 商品マスタ_手動発注リセット
```

### Action: 商品マスタ_手動発注リセット

```yaml
Action Name: 商品マスタ_手動発注リセット
Action Type: Data - Set row values
Target Table: 商品マスタ

Set these columns:
  手動発注追加フラグ: FALSE
  手動発注数量_箱: 0
```

## 運用フロー

```
1. ユーザーが「手動発注リクエスト」フォームから商品を追加
   ↓
2. Bot 1 が起動
   - 商品マスタの仮想カラム [_最新手動発注数量_箱] が手動発注リクエストの値を参照
   - アクションで仮想カラムの値を物理カラムにコピー
   ↓
3. 商品が発注リスト（発注対象商品スライス）に表示される
   ↓
4. 発注リストを確認し、発注記録を作成
   ↓
5. Bot 2 が起動し、手動発注カラムをリセット
   ↓
6. 商品が発注リストから削除される（自動発注対象でない場合）
```

## 注意事項

- 同じ商品に対して複数の手動発注リクエストがある場合、`ANY` により不定の1件が取得される。最新を取得したい場合は `MAXROW` を使用する。
- 手動発注リクエストテーブルは履歴として残る（削除しない運用を推奨）
- 発注実行前に手動発注リクエストを取り消したい場合は、商品マスタから直接フラグをOFFにする
