# 商品マスタ

## テーブル概要
- **テーブル名**: 商品マスタ
- **説明**: 医材の基本情報と在庫数を一元管理
- **主キー**: 商品ID
- **役割**: 医材マスタデータと在庫数の Single Source of Truth

## カラム定義

| カラム名 | 物理名 | データ型 | 必須 | 列種別 | 説明 |
|---------|--------|----------|------|--------|------|
| 商品ID | product_id | Text | ✓ | 物理 | 一意識別子（PRD-XXX形式） |
| 商品コード | product_code | Text | ✓ | 物理 | メーカー品番 |
| 管理番号 | management_number | Number | ✓ | 物理 | 社内管理番号 |
| 商品名 | product_name | Text | ✓ | 物理 | 医材名称 |
| 箱入数 | pieces_per_box | Number | ✓ | 物理 | 1箱あたりの個数 |
| 単位 | unit | Text | ✓ | 物理 | 個/本/袋/枚等 |
| 発注先ID | supplier_id | Ref | ✓ | 物理 | 発注先（発注先マスタ参照） |
| 棚番号 | shelf_number | Text | | 物理 | 保管棚番号 |
| 段数 | shelf_level | Text | | 物理 | 保管段数 |
| 定数在庫_個数 | fixed_stock_pieces | Number | | 物理 | 定数在庫数（個数単位、0の場合は定数管理なし） |
| 単価_箱 | unit_price_per_box | Decimal | | 物理 | 1箱あたりの単価 |
| 手動発注追加フラグ | manual_order_flag | Yes/No | | 物理 | 手動で発注リストに追加する場合にTRUE |
| 手動発注数量_箱 | manual_order_boxes | Number | | 物理 | 手動で追加する発注数量（箱単位） |
| 現在在庫個数 | current_stock_pieces | Number | | 仮想 | 現在の在庫個数（計算式: SUM(SELECT(在庫変動履歴[変動個数], [商品ID] = [_THISROW].[商品ID]))） |
| 現在在庫_箱表示 | current_stock_boxes_display | Number | | 仮想 | 箱単位での表示用（計算式: FLOOR([現在在庫個数] / IF([箱入数] > 0, [箱入数], 1))) |
| 現在在庫_端数表示 | current_stock_pieces_display | Number | | 仮想 | 端数の表示用（計算式: MOD([現在在庫個数], IF([箱入数] > 0, [箱入数], 1))) |
| 発注中個数 | pending_order_pieces | Number | | 仮想 | 発注中の個数（計算式: SUM(SELECT(発注記録[order_quantity_pieces], AND([product_id] = [_THISROW].[商品ID], [ステータス] <> "入荷済み"))) ) |
| 発注中箱数表示 | pending_order_boxes_display | Number | | 仮想 | 発注中の箱数表示（計算式: FLOOR([発注中個数] / IF([箱入数] > 0, [箱入数], 1))) |
| 予定在庫個数 | expected_stock_pieces | Number | | 仮想 | 予定在庫個数（計算式: [現在在庫個数] + [発注中個数]） |
| 自動発注対象フラグ | auto_order_flag | Yes/No | | 仮想 | 自動発注対象フラグ（計算式: AND([定数在庫_個数] > 0, [予定在庫個数] < [定数在庫_個数])） |
| 自動発注数量_箱 | auto_order_boxes | Number | | 仮想 | 自動計算による発注数量（計算式: IF([自動発注対象フラグ], CEILING(([定数在庫_個数] - [予定在庫個数]) / IF([箱入数] > 0, [箱入数], 1)), 0)） |
| 合計発注数量_箱 | total_order_boxes | Number | | 仮想 | 自動＋手動の合計発注数量（計算式: [自動発注数量_箱] + IF(ISBLANK([手動発注数量_箱]), 0, [手動発注数量_箱])） |
| 発注対象フラグ | order_required_flag | Yes/No | | 仮想 | 発注リスト表示フラグ（計算式: OR([自動発注対象フラグ], [手動発注追加フラグ] = TRUE)） |
| 発注先名 | supplier_name | Text | | 仮想 | 発注先名（計算式: [発注先ID].[発注先名]） |
| _最新手動発注数量_箱 | _latest_manual_order_boxes | Number | | 仮想 | オートメーション用。手動発注リクエストから最新値を取得（計算式: ANY(SELECT(手動発注リクエスト[手動発注数量_箱], [商品ID] = [_THISROW].[商品ID]))） |

## AppSheet設定
- **ラベル**: 商品名
- **キー**: 商品ID
- **リレーション**: 発注先ID → 発注先マスタ.supplier_id
- **計算式**:
  - 現在在庫個数 = SUM(SELECT(在庫変動履歴[変動個数], [商品ID] = [_THISROW].[商品ID]))
  - 現在在庫_箱表示 = FLOOR([現在在庫個数] / IF([箱入数] > 0, [箱入数], 1))
  - 現在在庫_端数表示 = MOD([現在在庫個数], IF([箱入数] > 0, [箱入数], 1))
  - 発注中個数 = SUM(SELECT(発注記録[order_quantity_pieces], AND([product_id] = [_THISROW].[商品ID], [ステータス] <> "入荷済み")))
  - 発注中箱数表示 = FLOOR([発注中個数] / IF([箱入数] > 0, [箱入数], 1))
  - 予定在庫個数 = [現在在庫個数] + [発注中個数]
  - 自動発注対象フラグ = AND([定数在庫_個数] > 0, [予定在庫個数] < [定数在庫_個数])
  - 自動発注数量_箱 = IF([自動発注対象フラグ], CEILING(([定数在庫_個数] - [予定在庫個数]) / IF([箱入数] > 0, [箱入数], 1)), 0)
  - 合計発注数量_箱 = [自動発注数量_箱] + IF(ISBLANK([手動発注数量_箱]), 0, [手動発注数量_箱])
  - 発注対象フラグ = OR([自動発注対象フラグ], [手動発注追加フラグ] = TRUE)
  - _最新手動発注数量_箱 = ANY(SELECT(手動発注リクエスト[手動発注数量_箱], [商品ID] = [_THISROW].[商品ID]))
- **表示形式**: 任意（在庫表示は在庫管理テーブルのビューで管理）
- **条件付き書式**: なし（必要に応じてカスタム設定）
- **補足**:
  - 全ての在庫は個数単位で管理され、表示用に箱・端数に分解して表示する
  - 予定在庫個数が定数を下回ったら発注対象フラグがTrueになり、発注リストに表示される
  - 定数在庫_個数が0の場合は定数管理を行わない

## スライス設定
- **発注リストスライス**:
  - スライス名: 発注対象商品
  - フィルタ条件: [発注対象フラグ] = TRUE
  - 表示カラム: 商品名、現在在庫個数、予定在庫個数、自動発注数量_箱、手動発注数量_箱、合計発注数量_箱、発注先名
  - 使用目的: 発注が必要な商品を一覧表示（自動・手動を統合）

## 手動発注追加の運用

手動発注リクエストテーブルからオートメーションで商品マスタの手動発注カラムが更新される。
詳細は以下を参照：
- 「17_手動発注リクエスト.md」- 入力テーブル定義
- 「18_手動発注オートメーション.md」- オートメーション設定
