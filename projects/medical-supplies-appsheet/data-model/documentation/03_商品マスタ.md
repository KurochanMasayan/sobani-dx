# 商品マスタ

## テーブル概要
- **テーブル名**: 商品マスタ
- **説明**: 医材の基本情報と在庫数を一元管理
- **主キー**: 商品ID
- **役割**: 医材マスタデータと在庫数の Single Source of Truth

## カラム定義

| カラム名 | 物理名 | データ型 | 必須 | 列種別 | 説明 |
|---------|--------|----------|------|--------|------|
| 商品ID | product_id | Text | ✓ | 物理 | 一意識別子（PRD-XXX形式） |
| 商品コード | product_code | Text | ✓ | 物理 | メーカー品番 |
| 管理番号 | management_number | Number | ✓ | 物理 | 社内管理番号 |
| 商品名 | product_name | Text | ✓ | 物理 | 医材名称 |
| 箱入数 | pieces_per_box | Number | ✓ | 物理 | 1箱あたりの個数 |
| 単位 | unit | Text | ✓ | 物理 | 個/本/袋/枚等 |
| 発注先ID | supplier_id | Ref | ✓ | 物理 | 発注先（発注先マスタ参照） |
| 棚番号 | shelf_number | Text | | 物理 | 保管棚番号 |
| 段数 | shelf_level | Text | | 物理 | 保管段数 |
| 定数在庫 | fixed_stock_flag | Yes/No | | 物理 | 定数在庫管理フラグ（TRUE:定数管理/FALSE:個別配布） |
| 定数在庫_箱 | fixed_stock_boxes | Number | | 物理 | 定数在庫数（箱単位） |
| 在庫合計個数 | total_stock_pieces | Number | | 仮想 | 在庫合計個数（計算式: SUM(SELECT(在庫管理[total_stock_pieces], [supply_id] = [_THISROW].[商品ID]))) |
| 現在在庫_箱 | current_stock_boxes | Number | | 仮想 | 箱単位の在庫（計算式: LET( total := [在庫合計個数], perBox := IF([箱入数] > 0, [箱入数], 1), FLOOR(total / perBox) )) |
| 現在在庫_個 | current_stock_pieces | Number | | 仮想 | 端数在庫（計算式: LET( total := [在庫合計個数], perBox := IF([箱入数] > 0, [箱入数], 1), total - (FLOOR(total / perBox) * perBox) )) |
| 発注中数量 | pending_orders | Number | | 仮想 | 発注中の数量（計算式: SUM(SELECT(発注記録[order_quantity_boxes], AND([supply_id] = [_THISROW].[商品ID], IN([status], {"申請中", "承認済", "発注済", "一部入荷"})))) ) |
| 発注先名 | supplier_name | Text | | 仮想 | 発注先名（計算式: [発注先ID].[発注先名]） |

## AppSheet設定
- **ラベル**: 商品名
- **キー**: 商品ID
- **リレーション**: 発注先ID → 発注先マスタ.supplier_id
- **計算式**:
  - 在庫合計個数 = SUM(SELECT(在庫管理[total_stock_pieces], [supply_id] = [_THISROW].[商品ID]))
  - 現在在庫_箱 = LET( total := [在庫合計個数], perBox := IF([箱入数] > 0, [箱入数], 1), FLOOR(total / perBox) )
  - 現在在庫_個 = LET( total := [在庫合計個数], perBox := IF([箱入数] > 0, [箱入数], 1), total - (FLOOR(total / perBox) * perBox) )
  - 発注中数量 = SUM(SELECT(発注記録[order_quantity_boxes], AND([supply_id] = [_THISROW].[商品ID], IN([status], {"申請中", "承認済", "発注済", "一部入荷"}))))
- **表示形式**: 任意（在庫表示は在庫管理テーブルのビューで管理）
- **条件付き書式**: なし（必要に応じてカスタム設定）
- **補足**: 在庫合計個数を箱入数で除算して箱・個に分解する際、現在在庫_個がマイナスにならないよう自動的に箱を調整（箱を1減らし箱入数分を個数に加算）
