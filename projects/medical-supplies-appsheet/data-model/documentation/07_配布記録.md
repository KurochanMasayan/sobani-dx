# 配布記録

## テーブル概要
- **テーブル名**: distribution_records
- **説明**: 施設への医材配布履歴を記録
- **主キー**: 配布ID

## カラム定義

| カラム名 | 物理名 | データ型 | 必須 | 列種別 | 説明 |
|---------|--------|----------|------|--------|------|
| 配布ID | distribution_id | UniqueID | ✓ | 物理 | 一意識別子（自動生成） |
| 配布日 | distribution_date | Date | ✓ | 物理 | 配布実施日 |
| 施設ID | facility_id | Ref | ✓ | 物理 | 配布先施設（facilities参照） |
| 患者ID | patient_id | Ref | ✓ | 物理 | 対象患者（patients参照） |
| 商品ID | product_id | Ref | ✓ | 物理 | 配布医材（商品マスタ参照） |
| 配布数量 | quantity | Number | ✓ | 物理 | 配布個数 |
| 配布者 | distributed_by | Email | ✓ | 物理 | 配布担当者 |
| テンプレートID | template_id | Ref | | 物理 | 使用テンプレート（distribution_templates参照） |
| 備考 | notes | Text | | 物理 | 配布時メモ |
| 施設名 | facility_name | Text | | 仮想 | 施設名（計算式: [施設ID].[施設名]） |
| 患者名 | patient_name | Text | | 仮想 | 患者名（計算式: [患者ID].[フルネーム]） |
| 商品名 | product_name | Text | | 仮想 | 商品名（計算式: [商品ID].[商品名]） |
| 配布ラベル | distribution_label | Text | | 仮想 | ラベル（計算式: CONCATENATE(TEXT([配布日]), " ", [施設名], " ", [患者名])） |
| 月区分 | month_type | Text | | 仮想 | 月区分（計算式: IF(MOD(MONTH([配布日]), 2) = 0, "偶数月", "奇数月")） |

## AppSheet設定
- **ラベル**: CONCATENATE(TEXT([配布日]), " ", [施設ID].[施設名])
- **キー**: 配布ID
- **リレーション**:
  - 施設ID → 施設マスタ.facility_id
  - 患者ID → 患者マスタ.patient_id
  - 商品ID → 商品マスタ.supply_id
  - テンプレートID → 配布テンプレート.template_id
- **初期値**:
  - 配布日 = TODAY()
  - 配布者 = USEREMAIL()
- **アクション**:
  - 配布実行時: 在庫管理[stock_pieces] から配布数量を減算し、個数がマイナスになった場合は在庫管理[stock_boxes] を1減らして箱入数分を在庫管理[stock_pieces] に加算
- **並び順**: 配布日 DESC
