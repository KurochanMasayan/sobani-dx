# 発注管理 (purchase_orders)

## テーブル概要
- **テーブル名**: purchase_orders
- **説明**: 医材の発注と入荷を管理
- **主キー**: 発注ID

## カラム定義

| カラム名 | 物理名 | データ型 | 必須 | 列種別 | 説明 |
|---------|--------|----------|------|--------|------|
| 発注ID | order_id | UniqueID | ✓ | 物理 | 一意識別子（自動生成） |
| 発注番号 | order_number | Text | ✓ | 物理 | 管理用発注番号（PO-YYYYMM-XXX） |
| 発注日 | order_date | Date | ✓ | 物理 | 発注実施日 |
| 商品ID | product_id | Ref | ✓ | 物理 | 発注商品（products参照） |
| 発注数量_箱 | order_quantity_boxes | Number | ✓ | 物理 | 発注箱数 |
| 発注先ID | supplier_id | Ref | ✓ | 物理 | 発注先（suppliers参照） |
| 納期予定日 | expected_delivery_date | Date | | 物理 | 納品予定日 |
| 入荷日 | delivery_date | Date | | 物理 | 実際の入荷日 |
| 入荷数量_箱 | delivered_quantity_boxes | Number | | 物理 | 実際の入荷箱数 |
| 状態 | status | Enum | ✓ | 物理 | 発注中/入荷済み/キャンセル |
| 発注者 | ordered_by | Email | ✓ | 物理 | 発注担当者 |
| 備考 | notes | Text | | 物理 | 特記事項 |
| 作成日時 | created_at | DateTime | ✓ | 物理 | レコード作成日時 |
| 商品名 | product_name | Text | | 仮想 | 商品名（計算式: [商品ID].[商品名]） |
| 発注先名 | supplier_name | Text | | 仮想 | 発注先名（計算式: [発注先ID].[発注先名]） |
| 発注残数_箱 | pending_boxes | Number | | 仮想 | 発注残（計算式: [発注数量_箱] - IF(ISBLANK([入荷数量_箱]), 0, [入荷数量_箱])） |
| 納期超過日数 | overdue_days | Number | | 仮想 | 超過日数（計算式: IF(AND([状態] = "発注中", [納期予定日] < TODAY()), TODAY() - [納期予定日], 0)） |
| 納期状態 | delivery_status | Text | | 仮想 | 納期状態（計算式: IF([状態] = "入荷済み", "完了", IF([納期超過日数] > 0, "遅延", "期限内"))） |

## 状態の選択肢
- 発注中
- 一部入荷
- 入荷済み
- キャンセル

## AppSheet設定
- **ラベル**: [発注番号]
- **キー**: 発注ID
- **リレーション**:
  - 商品ID → products.product_id
  - 発注先ID → suppliers.supplier_id
- **初期値**:
  - 発注日 = TODAY()
  - 状態 = "発注中"
  - 発注者 = USEREMAIL()
  - 作成日時 = NOW()
- **計算式**:
  - 発注残数 = [発注数量_箱] - [入荷数量_箱]
- **アクション**:
  - 入荷処理時: inventory.current_stock_boxes に入荷数量を加算
- **条件付き書式**:
  - 発注中: 黄色背景
  - 納期超過: 赤文字で警告