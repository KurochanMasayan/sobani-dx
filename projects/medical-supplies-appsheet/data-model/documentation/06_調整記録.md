# 調整記録

## テーブル概要
- **テーブル名**: 調整記録
- **説明**: 在庫数量の調整記録（棚卸、廃棄、破損等）
- **主キー**: 調整ID
- **役割**: 実在庫と帳簿在庫の差異調整、在庫精度の維持

## カラム定義

| カラム名 | 物理名 | データ型 | 必須 | 列種別 | 説明 |
|---------|--------|----------|------|--------|------|
| 調整ID | adjustment_id | Text | ✓ | 物理 | 一意識別子（ADJ-YYYYMMDD-XXX形式） |
| 調整日 | adjustment_date | Date | ✓ | 物理 | 調整実施日 |
| 調整タイプ | adjustment_type | Enum | ✓ | 物理 | 棚卸/返却/廃棄/破損/その他 |
| 商品ID | product_id | Ref | ✓ | 物理 | 商品（商品マスタ参照） |
| 実在庫個数 | actual_stock_pieces | Number | ✓ | 物理 | 実際に確認した個数 |
| 実在庫_箱入力 | actual_stock_boxes_input | Number | | 物理 | 調整時の箱入力（UI入力用） |
| 実在庫_端数入力 | actual_stock_pieces_input | Number | | 物理 | 調整時の端数入力（UI入力用） |
| 帳簿在庫個数 | book_stock_pieces | Number | ✓ | 物理 | 調整前の帳簿在庫個数 |
| 差異個数 | diff_pieces | Number | ✓ | 物理 | 実在庫と帳簿在庫の差個数 |
| 施設ID | facility_id | Ref | | 物理 | 返却元施設（施設マスタ参照、返却時のみ） |
| 患者ID | patient_id | Ref | | 物理 | 返却元患者（患者マスタ参照、個人特定時のみ） |
| 実施者 | conducted_by | Text | ✓ | 物理 | 調整実施者名 |
| 承認者 | approved_by | Text | | 物理 | 調整結果承認者名 |
| 承認日時 | approved_at | DateTime | | 物理 | 承認日時 |
| ステータス | status | Enum | ✓ | 物理 | 実施中/承認待ち/承認済み/却下 |
| 備考 | notes | LongText | | 物理 | その他メモ |
| 商品名 | product_name | Text | | 仮想 | 商品名（計算式: [商品ID].[商品名]） |
| 実在庫_箱表示 | actual_stock_boxes_display | Number | | 仮想 | 実在庫箱数表示（計算式: FLOOR([実在庫個数] / [商品ID].[箱入数])） |
| 実在庫_端数表示 | actual_stock_pieces_display | Number | | 仮想 | 実在庫端数表示（計算式: MOD([実在庫個数], [商品ID].[箱入数])） |
| 帳簿在庫_箱表示 | book_stock_boxes_display | Number | | 仮想 | 帳簿在庫箱数表示（計算式: FLOOR([帳簿在庫個数] / [商品ID].[箱入数])） |
| 帳簿在庫_端数表示 | book_stock_pieces_display | Number | | 仮想 | 帳簿在庫端数表示（計算式: MOD([帳簿在庫個数], [商品ID].[箱入数])） |
| 差異率 | diff_rate | Percent | | 仮想 | 差異率（計算式: IF([帳簿在庫個数] > 0, ABS([差異個数]) / [帳簿在庫個数], 0)） |

## AppSheet設定
- **ラベル**: CONCATENATE([商品名], " - ", TEXT([調整日]))
- **キー**: 調整ID
- **リレーション**: 商品ID → 商品マスタ.supply_id
- **初期値**:
  - 調整日 = TODAY()
  - 帳簿在庫個数 = [商品ID].[現在在庫個数]
  - ステータス = "実施中"
  - 実施者 = USEREMAIL()
- **計算式**:
  - 実在庫個数 = ([実在庫_箱入力] * [商品ID].[箱入数]) + [実在庫_端数入力]
  - 差異個数 = [実在庫個数] - [帳簿在庫個数]
- **アクション**:
  - 承認時: 在庫変動履歴に「在庫調整」として差異個数を記録（変動個数：差異個数）
- **バリデーション**:
  - 実在庫は0以上
  - 大きな差異（±20%以上）の場合は調整理由必須

## ビジネスルール
1. 在庫調整は必要に応じて実施（棚卸、廃棄、破損等）
2. 差異が発生した場合は必ず理由を記録
3. 承認後に在庫変動履歴に差異を記録（在庫は自動計算）
4. 調整内容は在庫変動履歴に記録される
