# 調整記録

## テーブル概要
- **テーブル名**: 調整記録
- **説明**: 在庫数量の調整記録（棚卸、廃棄、破損等）
- **主キー**: 調整ID
- **役割**: 実在庫と帳簿在庫の差異調整、在庫精度の維持

## カラム定義

| カラム名 | 物理名 | データ型 | 必須 | 列種別 | 説明 |
|---------|--------|----------|------|--------|------|
| 調整ID | adjustment_id | Text | ✓ | 物理 | 一意識別子（ADJ-YYYYMMDD-XXX形式） |
| 調整日 | adjustment_date | Date | ✓ | 物理 | 調整実施日 |
| 調整タイプ | adjustment_type | Enum | ✓ | 物理 | 棚卸/返却/廃棄/破損/その他 |
| 商品ID | product_id | Ref | ✓ | 物理 | 商品（商品マスタ参照） |
| 実在庫個数 | actual_stock_pieces | Number | ✓ | 物理 | 実際に確認した個数 |
| 実在庫_箱入力 | actual_stock_boxes_input | Number | | 物理 | 調整時の箱入力（UI入力用） |
| 実在庫_端数入力 | actual_stock_pieces_input | Number | | 物理 | 調整時の端数入力（UI入力用） |
| 帳簿在庫個数 | book_stock_pieces | Number | ✓ | 物理 | 調整前の帳簿在庫個数 |
| 棚卸差異個数 | inventory_diff_pieces | Number | | 物理 | 実在庫と帳簿在庫の差個数（棚卸時のみ使用） |
| 調整個数 | adjustment_pieces | Number | | 物理 | 調整数量（返却/廃棄/破損/その他で使用、＋：増加、－：減少） |
| 変動個数 | change_pieces | Number | ✓ | 物理 | 在庫変動数量（AppFormulaで自動計算、在庫変動履歴への記録用） |
| 施設ID | facility_id | Ref | | 物理 | 返却元施設（施設マスタ参照、返却時のみ） |
| 患者ID | patient_id | Ref | | 物理 | 返却元患者（患者マスタ参照、個人特定時のみ） |
| 実施者 | conducted_by | Text | ✓ | 物理 | 調整実施者名 |
| 承認者 | approved_by | Text | | 物理 | 調整結果承認者名 |
| 承認日時 | approved_at | DateTime | | 物理 | 承認日時 |
| ステータス | status | Enum | ✓ | 物理 | 実施中/承認待ち/承認済み/却下 |
| 備考 | notes | LongText | | 物理 | その他メモ |
| 商品名 | product_name | Text | | 仮想 | 商品名（計算式: [商品ID].[商品名]） |
| 実在庫_箱表示 | actual_stock_boxes_display | Number | | 仮想 | 実在庫箱数表示（計算式: FLOOR([実在庫個数] / [商品ID].[箱入数])） |
| 実在庫_端数表示 | actual_stock_pieces_display | Number | | 仮想 | 実在庫端数表示（計算式: MOD([実在庫個数], [商品ID].[箱入数])） |
| 帳簿在庫_箱表示 | book_stock_boxes_display | Number | | 仮想 | 帳簿在庫箱数表示（計算式: FLOOR([帳簿在庫個数] / [商品ID].[箱入数])） |
| 帳簿在庫_端数表示 | book_stock_pieces_display | Number | | 仮想 | 帳簿在庫端数表示（計算式: MOD([帳簿在庫個数], [商品ID].[箱入数])） |
| 差異率 | diff_rate | Percent | | 仮想 | 差異率（棚卸時のみ、計算式: IF(AND([調整タイプ] = "棚卸", [帳簿在庫個数] > 0), ABS([棚卸差異個数]) / [帳簿在庫個数], 0)） |

## AppSheet設定
- **ラベル**: CONCATENATE([商品名], " - ", TEXT([調整日]))
- **キー**: 調整ID
- **リレーション**: 商品ID → 商品マスタ.supply_id
- **初期値**:
  - 調整日 = TODAY()
  - 帳簿在庫個数 = [商品ID].[現在在庫個数]
  - ステータス = "実施中"
  - 実施者 = USEREMAIL()
- **App Formula（物理カラム自動計算）**:
  - 実在庫個数 = ([実在庫_箱入力] * [商品ID].[箱入数]) + [実在庫_端数入力]
  - 棚卸差異個数 = IF([調整タイプ] = "棚卸", [実在庫個数] - [帳簿在庫個数], "")
  - 変動個数 = IF([調整タイプ] = "棚卸", [棚卸差異個数], [調整個数])
- **計算式（仮想カラム）**:
  - 商品名 = [商品ID].[商品名]
  - 実在庫_箱表示 = FLOOR([実在庫個数] / [商品ID].[箱入数])
  - 実在庫_端数表示 = MOD([実在庫個数], [商品ID].[箱入数])
  - 帳簿在庫_箱表示 = FLOOR([帳簿在庫個数] / [商品ID].[箱入数])
  - 帳簿在庫_端数表示 = MOD([帳簿在庫個数], [商品ID].[箱入数])
  - 差異率 = IF(AND([調整タイプ] = "棚卸", [帳簿在庫個数] > 0), ABS([棚卸差異個数]) / [帳簿在庫個数], 0)
- **アクション**:
  - 承認時: 在庫変動履歴に「在庫調整」として変動個数を記録（変動個数：[変動個数]）
- **バリデーション**:
  - 実在庫は0以上
  - 大きな差異（±20%以上）の場合は調整理由必須

## ビジネスルール
1. 在庫調整は必要に応じて実施（棚卸、廃棄、破損等）
2. **調整タイプによる使い分け**:
   - **棚卸**: 実在庫個数と帳簿在庫個数を入力 → 棚卸差異個数が自動計算
   - **返却**: 調整個数に返却数量を入力（＋）
   - **廃棄**: 調整個数に廃棄数量を入力（－）
   - **破損**: 調整個数に破損数量を入力（－）
   - **その他**: 調整個数に調整数量を入力（＋または－）
3. 差異が発生した場合は必ず理由を記録
4. 承認後に在庫変動履歴に変動個数を記録（在庫は自動計算）
5. 調整内容は在庫変動履歴に記録される

## 使用例

### 例1: 棚卸（差異あり）
```
調整タイプ: 棚卸
商品ID: PRD-006
実在庫_箱入力: 2
実在庫_端数入力: 45
→ 実在庫個数 = 245 (AppFormula自動計算)
帳簿在庫個数: 250 (自動取得)
→ 棚卸差異個数 = -5 (AppFormula自動計算)
調整個数: (空)
→ 変動個数 = -5 (AppFormula自動計算)
備考: 個数差異あり（計数ミス）
```

### 例2: 返却
```
調整タイプ: 返却
商品ID: PRD-001
棚卸差異個数: (空)
調整個数: 4 (手入力)
→ 変動個数 = 4 (AppFormula自動計算)
施設ID: faci-001
患者ID: 123456
備考: 患者Aより未使用で返却
```

### 例3: 廃棄
```
調整タイプ: 廃棄
商品ID: PRD-005
棚卸差異個数: (空)
調整個数: -15 (手入力、マイナス値)
→ 変動個数 = -15 (AppFormula自動計算)
備考: 使用期限切れによる廃棄
```
