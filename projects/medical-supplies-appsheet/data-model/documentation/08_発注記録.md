# 発注記録

## テーブル概要
- **テーブル名**: 発注記録
- **説明**: 医材の発注と入荷を管理
- **主キー**: 発注ID

## カラム定義

| カラム名 | 物理名 | データ型 | 必須 | 列種別 | 説明 |
|---------|--------|----------|------|--------|------|
| 発注ID | order_id | UniqueID | ✓ | 物理 | 一意識別子（自動生成） |
| 発注日 | order_date | Date | ✓ | 物理 | 発注実施日 |
| 商品ID | product_id | Ref | ✓ | 物理 | 発注商品（商品マスタ参照） |
| 商品名 | product_name | Text | | 仮想 | 商品名（計算式: [商品ID].[商品名]） |
| 発注箱数 | order_boxes_input | Number | ✓ | 物理 | 発注箱数（入力用） |
| 発注個数 | order_quantity_pieces | Number | ✓ | 物理 | 発注個数（自動計算された値を保存） |
| 発注ラベル | order_label | Text | ✓ | 物理 | 発注表示ラベル（商品名_N箱形式） |
| 単価_箱 | unit_price_per_box | Number | ✓ | 物理 | 1箱あたり単価 |
| 単価_個 | unit_price_per_piece | Number | | 仮想 | 1個あたり単価（計算式: [単価_箱] / [箱入数]） |
| 発注先ID | supplier_id | Ref | ✓ | 物理 | 発注先（発注先マスタ参照） |
| 納期予定日 | expected_delivery_date | Date | | 物理 | 納品予定日 |
| ステータス | status | Text | | 仮想 | 入荷状態（計算式参照） |
| 発注者 | ordered_by | Email | ✓ | 物理 | 発注担当者 |
| 備考 | notes | Text | | 物理 | 特記事項 |
| 作成日時 | created_at | DateTime | ✓ | 物理 | レコード作成日時 |
| 合計金額 | total_amount | Number | ✓ | 物理 | 合計金額 |
| 発注先名 | supplier_name | Text | | 仮想 | 発注先名（計算式: [発注先ID].[発注先名]） |
| 関連入荷 | Related 入荷記録 | List | | 仮想 | 紐づく入荷レコード一覧（IsPartOf により自動生成） |
| 箱入数 | pieces_per_box | Number | | 仮想 | 箱入数（計算式: [商品ID].[箱入数]） |
| 受入済個数 | received_total_pieces | Number | | 仮想 | 入荷個数合計（計算式: SUM([Related 入荷記録][入荷個数])） |
| 残個数 | pending_pieces | Number | | 仮想 | 発注残個数（計算式: [発注個数] - [受入済個数]） |
| 発注箱数_表示 | order_boxes_display | Number | | 仮想 | 発注箱数表示（計算式: FLOOR([発注個数] / [箱入数])） |
| 受入済箱数_表示 | received_boxes_display | Number | | 仮想 | 受入済箱数表示（計算式: FLOOR([受入済個数] / [箱入数])） |
| 納期超過日数 | overdue_days | Number | | 仮想 | 超過日数（計算式: IF(AND([ステータス] <> "入荷済み", [納期予定日] < TODAY()), TODAY() - [納期予定日], 0)） |
| 納期状態 | delivery_status | Text | | 仮想 | 納期状態（計算式: IF([ステータス] = "入荷済み", "完了", IF([納期超過日数] > 0, "遅延", "期限内"))） |

## ステータスの選択肢
- 発注済み
- 一部入荷
- 入荷済み

## AppSheet設定
- **ラベル**: [発注ラベル]
- **キー**: 発注ID
- **リレーション**:
  - 商品ID → 商品マスタ.商品ID
  - 発注先ID → 発注先マスタ.supplier_id
  - 関連入荷 → 入荷記録.order_id（IsPartOf）
- **初期値**:
  - 発注日 = TODAY()
  - 発注者 = USEREMAIL()
  - 作成日時 = NOW()
  - 合計金額 = [発注箱数] * [単価_箱]
- **計算式**:
  - 商品名 = [商品ID].[商品名]
  - 発注ラベル = CONCATENATE([商品名], "_", [発注箱数], "箱")
  - 発注個数 = [発注箱数] * [箱入数]
  - 受入済個数 = SUM([Related 入荷記録][入荷個数])
  - 残個数 = MAX(0, [発注個数] - [受入済個数])
  - ステータス = IF([受入済個数] = 0, "発注済み", IF([受入済個数] < [発注個数], "一部入荷", "入荷済み"))
- **アクション**:
  - 入荷登録: 関連入荷テーブル（入荷記録）への子レコード作成フォームを起動
  - 発注は箱単位で入力し、個数に自動変換して保存
- **条件付き書式**:
  - 発注済み: 黄色背景
  - 一部入荷: オレンジ文字
  - 納期超過: 赤文字で警告
