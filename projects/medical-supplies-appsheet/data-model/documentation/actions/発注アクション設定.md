# 発注アクション設定

## 1. 独立したアクション構成

### A. PDF出力アクション（メインボタン）
```yaml
Action Name: 発注リストPDF出力
For Table: 商品マスタ
Do This: External: start a process
Process Name: 発注リストPDF生成
Prominence: Prominent（目立つボタンとして表示）
Icon: print
Display Name: 発注リストPDF
Condition: COUNT(SELECT(商品マスタ[商品ID], [発注対象フラグ] = TRUE)) > 0
Position: Table header（テーブル上部に配置）
```

### B. 発注記録作成アクション（オプション実行）
```yaml
Action Name: PDF確認後_発注実行
For Table: 商品マスタ
Do This: Data: execute an action on a set of rows
Referenced Table: 商品マスタ
Referenced Rows: SELECT(商品マスタ[商品ID], [発注対象フラグ] = TRUE)
Referenced Action: 個別商品発注
Prominence: Do not display（非表示）
```

### C. 個別商品発注（補助アクション）
```yaml
Action Name: 個別商品発注
For Table: 商品マスタ
Do This: Data: add a new row to another table using values from this row
Target Table: 発注記録
Set These Columns:
  - 発注ID: UNIQUEID()
  - 発注日: TODAY()
  - 商品ID: [_THISROW].[商品ID]
  - 発注箱数: [_THISROW].[発注推奨箱数]
  - 発注ラベル: CONCATENATE([_THISROW].[商品名], "_", [_THISROW].[発注推奨箱数], "箱")
  - 単価_箱: [_THISROW].[単価_箱]
  - 発注先ID: [_THISROW].[推奨発注先ID]
  - 合計金額: [_THISROW].[発注推奨箱数] * [_THISROW].[単価_箱]
  - 納期予定日: TODAY() + 7
  - 発注者: USEREMAIL()
  - 備考: "発注リストから作成"
  - 作成日時: NOW()
Condition: [発注対象フラグ] = TRUE
Prominence: Do not display（非表示）
```

## 2. 発注ビューの作成

### 発注対象商品ビュー
```yaml
View Name: 発注対象商品
For Table: 商品マスタ
View Type: Table
Columns:
  - 商品ID
  - 商品名
  - 現在在庫個数
  - 定数在庫_個数
  - 発注推奨数（仮想列）
  - 単価_箱
Row Filter: [発注対象フラグ = TRUE]
Actions:
  - 商品を発注（行レベル）
  - 発注対象商品を一括発注（テーブルレベル）
  - 発注リストPDF出力（テーブルレベル）
```

## 3. 発注推奨数の仮想列追加

商品マスタに以下の仮想列を追加：

```yaml
Column Name: 発注推奨箱数
Type: Number
App Formula:
  IF([発注対象フラグ],
    CEILING(([定数在庫_個数] - [現在在庫個数]) / [箱入数_個数]),
    0
  )

Column Name: 発注推奨個数
Type: Number
App Formula:
  [発注推奨箱数] * [箱入数_個数]

Column Name: 発注推定金額
Type: Price
App Formula:
  [発注推奨箱数] * [単価_箱]
```

## 4. 発注先の自動選択ロジック

商品マスタに推奨発注先の仮想列を追加：

```yaml
Column Name: 推奨発注先ID
Type: Ref
App Formula:
  IF(ISNOTBLANK([優先発注先ID]),
    [優先発注先ID],
    "store-01"  # デフォルト発注先
  )
```

## 5. 発注後の処理

### 発注完了後のボット
```yaml
Bot Name: 発注後処理
Event:
  Type: Data Change
  Table: 発注記録
  Event Type: Adds only

Process:
  Step 1: 在庫変動履歴に記録
    - Action: Add row
    - Table: 在庫変動履歴
    - Values:
      変動ID: UNIQUEID()
      変動日: TODAY()
      商品ID: [商品ID]
      変動種別: "発注"
      変動個数: 0  # 発注時点では在庫変動なし
      変動後在庫: [商品ID].[現在在庫個数]

  Step 2: 通知送信
    - Action: Send email
    - To: [発注者]
    - Subject: "発注完了通知"
    - Body: 発注内容の詳細
```

## 6. 実装手順

1. **商品マスタに仮想列追加**
   - 発注推奨箱数
   - 発注推奨個数
   - 発注推定金額
   - 推奨発注先ID

2. **アクション作成**
   - 個別発注アクション
   - 一括発注アクション

3. **ビュー作成**
   - 発注対象商品ビュー
   - アクションボタン配置

4. **PDFテンプレート作成**
   - Google Docsでテンプレート作成
   - AppSheetに登録

5. **ボット設定**
   - PDF出力ボット
   - 発注後処理ボット

6. **テスト**
   - 個別発注テスト
   - 一括発注テスト
   - PDF出力テスト