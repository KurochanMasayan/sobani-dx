# 箱詰記録

## テーブル概要
- **テーブル名**: 箱詰記録
- **説明**: 医材を配布用に箱詰めする際の記録
- **主キー**: 箱詰ID
- **役割**: 配布準備として個別商品を箱単位にまとめる作業の記録

## カラム定義

| カラム名 | 物理名 | データ型 | 必須 | 列種別 | 説明 |
|---------|--------|----------|------|--------|------|
| 箱詰ID | packing_id | UniqueID | ✓ | 物理 | 一意識別子（自動生成） |
| 箱詰日 | packing_date | Date | ✓ | 物理 | 箱詰実施日 |
| 商品ID | product_id | Ref | ✓ | 物理 | 対象商品（商品マスタ参照） |
| 箱ID | box_id | Text | ✓ | 物理 | 箱の識別ID |
| 施設ID | facility_id | Ref | ✓ | 物理 | 配布先施設（facilities参照） |
| 患者ID | patient_id | Ref | | 物理 | 対象患者（patients参照） |
| 箱詰数量 | packed_pieces | Number | ✓ | 物理 | 箱詰めした個数 |
| 作業者 | packed_by | Email | ✓ | 物理 | 箱詰作業者 |
| 配布予定日 | scheduled_distribution_date | Date | | 物理 | 配布予定日 |
| 備考 | notes | LongText | | 物理 | 作業メモ |
| 作成日時 | created_at | DateTime | ✓ | 物理 | レコード作成日時 |
| 商品名 | product_name | Text | | 仮想 | 商品名（計算式: [商品ID].[商品名]） |
| 施設名 | facility_name | Text | | 仮想 | 施設名（計算式: IF(ISNOTBLANK([施設ID]), [施設ID].[施設名], "")） |
| 患者名 | patient_name | Text | | 仮想 | 患者名（計算式: IF(ISNOTBLANK([患者ID]), [患者ID].[フルネーム], "")） |
| 箱詰ラベル | packing_label | Text | | 仮想 | ラベル（計算式: CONCATENATE(TEXT([箱詰日]), " ", [商品名], " ", [箱詰数量], "個")） |

## AppSheet設定
- **ラベル**: [箱詰ラベル]
- **キー**: 箱詰ID
- **リレーション**:
  - 商品ID → 商品マスタ.商品ID
  - 箱ID → 箱マスタ.箱ID
  - 施設ID → 施設マスタ.facility_id
  - 患者ID → 患者マスタ.patient_id
- **初期値**:
  - 箱詰日 = TODAY()
  - 作業者 = USEREMAIL()
  - 作成日時 = NOW()
- **計算式**:
  - 商品名 = [商品ID].[商品名]
  - 施設名 = IF(ISNOTBLANK([施設ID]), [施設ID].[施設名], "")
  - 患者名 = IF(ISNOTBLANK([患者ID]), [患者ID].[フルネーム], "")
- **アクション**:
  - 箱詰中の箱がない場合: 箱マスタに新規レコード追加（箱ID自動生成、ステータス="箱詰済み"）
  - 完了時: 在庫変動履歴に「箱詰」として記録（変動個数：－箱詰数量）
  - 完了時: 箱マスタ[ステータス]を"箱詰済み"に更新
- **バリデーション**:
  - 箱詰数量 > 0
  - 現在在庫個数 >= 箱詰数量（在庫不足チェック）
  - 箱IDは自動生成または既存の箱から選択
- **並び順**: 箱詰日 DESC

## ビジネスルール
1. 箱詰作業は配布準備として実施
2. 複数日にわたる箱詰作業に対応（箱ラベルで管理）
3. 箱詰数量は現在在庫を超えてはならない
4. 箱詰記録作成時に箱マスタに自動的にレコード追加
5. キャンセル時は在庫を元の状態に戻す
6. 箱詰により在庫が減少し、定数を下回ったら発注対象となる

## 他テーブルとの関係
- **商品マスタ**: 箱入数情報を参照
- **在庫変動履歴**: 箱詰作業を記録（在庫減少）
- **箱マスタ**: 箱IDで紐付け、配布状況を管理

## ビュー例
- 箱詰一覧ビュー（テーブルビュー）
- 本日の箱詰作業ビュー（カードビュー）
- 商品別箱詰履歴ビュー（グループ化ビュー）
- 配布待ち箱詰ビュー（フィルタビュー）
- 箱ID別一覧ビュー（グループ化ビュー）