# 箱詰記録

## テーブル概要
- **テーブル名**: 箱詰記録
- **説明**: 医材を配布用に箱詰めする際の記録
- **主キー**: 箱詰ID
- **役割**: 配布準備として個別商品を箱単位にまとめる作業の記録

## カラム定義

| カラム名 | 物理名 | データ型 | 必須 | 列種別 | 説明 |
|---------|--------|----------|------|--------|------|
| 箱詰ID | packing_id | UniqueID | ✓ | 物理 | 一意識別子（自動生成） |
| 箱詰日 | packing_date | Date | ✓ | 物理 | 箱詰実施日 |
| 商品ID | product_id | Ref | ✓ | 物理 | 対象商品（商品マスタ参照） |
| 箱番号 | box_number | Text | ✓ | 物理 | 箱詰めする箱の識別番号 |
| 箱詰数量_箱 | packed_boxes | Number | ✓ | 物理 | 箱詰めした箱数 |
| 箱詰数量_個数 | packed_pieces | Number | ✓ | 物理 | 箱詰めした総個数（自動計算） |
| ロット番号 | lot_number | Text | | 物理 | ロット番号（任意） |
| 作業者 | packed_by | Email | ✓ | 物理 | 箱詰作業者 |
| ステータス | status | Enum | ✓ | 物理 | 作業中/完了/キャンセル |
| 配布予定日 | scheduled_distribution_date | Date | | 物理 | 配布予定日 |
| 備考 | notes | LongText | | 物理 | 作業メモ |
| 作成日時 | created_at | DateTime | ✓ | 物理 | レコード作成日時 |
| 商品名 | product_name | Text | | 仮想 | 商品名（計算式: [商品ID].[商品名]） |
| 箱入数 | pieces_per_box | Number | | 仮想 | 箱入数（計算式: [商品ID].[箱入数]） |
| 箱詰ラベル | packing_label | Text | | 仮想 | ラベル（計算式: CONCATENATE(TEXT([箱詰日]), " ", [商品名], " ", [箱詰数量_箱], "箱")） |

## AppSheet設定
- **ラベル**: [箱詰ラベル]
- **キー**: 箱詰ID
- **リレーション**:
  - 商品ID → 商品マスタ.product_id
- **初期値**:
  - 箱詰日 = TODAY()
  - ステータス = "作業中"
  - 作業者 = USEREMAIL()
  - 作成日時 = NOW()
- **計算式**:
  - 箱詰数量_個数 = [箱詰数量_箱] * [箱入数]
  - 商品名 = [商品ID].[商品名]
  - 箱入数 = [商品ID].[箱入数]
- **アクション**:
  - 完了時: 在庫変動履歴に「箱詰」として記録（在庫から減算）
  - 完了時: 商品マスタ[現在在庫個数]から箱詰数量_個数を減算
- **バリデーション**:
  - 箱詰数量_箱 > 0
  - 現在在庫個数 >= 箱詰数量_個数（在庫不足チェック）
- **並び順**: 箱詰日 DESC

## ビジネスルール
1. 箱詰作業は配布準備として実施
2. 複数日にわたる箱詰作業に対応（箱番号で管理）
3. 箱詰数量は現在在庫を超えてはならない
4. キャンセル時は在庫を元の状態に戻す
5. 箱詰により在庫が減少し、定数を下回ったら発注対象となる

## 他テーブルとの関係
- **商品マスタ**: 箱入数情報を参照、在庫を減算
- **在庫変動履歴**: 箱詰作業を記録（在庫減少）
- **配布記録**: 箱詰完了後に配布可能

## ビュー例
- 箱詰一覧ビュー（テーブルビュー）
- 本日の箱詰作業ビュー（カードビュー）
- 商品別箱詰履歴ビュー（グループ化ビュー）
- 配布待ち箱詰ビュー（フィルタビュー）
- 箱番号別一覧ビュー（グループ化ビュー）