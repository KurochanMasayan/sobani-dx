# 箱マスタ

## テーブル概要
- **テーブル名**: 箱マスタ
- **説明**: 配布用の箱を管理し、配布状況を追跡
- **主キー**: 箱ID
- **役割**: 箱詰め済み商品の配布状況管理

## カラム定義

| カラム名 | 物理名 | データ型 | 必須 | 列種別 | 説明 |
|---------|--------|----------|------|--------|------|
| 箱ID | box_id | Text | ✓ | 物理 | 箱の一意識別子（BOX-YYYY-XXX形式） |
| 箱名 | box_name | Text | | 物理 | 箱の名称・ラベル |
| 作成日 | created_date | Date | ✓ | 物理 | 箱の作成日 |
| ステータス | status | Enum | ✓ | 物理 | 箱詰済み/配布済み |
| 配布日 | distribution_date | Date | | 物理 | 配布実施日 |
| 配布者 | distributed_by | Email | | 物理 | 配布担当者 |
| 備考 | notes | LongText | | 物理 | 配布メモ |
| 作成者 | created_by | Email | ✓ | 物理 | 箱作成者 |
| 箱詰商品数 | packed_items_count | Number | | 仮想 | 箱詰された商品種類数（計算式: COUNT(SELECT(箱詰記録[箱詰ID], [箱ID] = [_THISROW].[箱ID]))） |
| 配布済みフラグ | is_distributed | Yes/No | | 仮想 | 配布済みかどうか（計算式: [ステータス] = "配布済み"） |
| 箱ラベル | box_label | Text | | 仮想 | 表示用ラベル（計算式: CONCATENATE([箱ID], " (", [ステータス], ")")） |

## AppSheet設定
- **ラベル**: [箱ラベル]
- **キー**: 箱ID
- **リレーション**:
  - 箱詰記録.箱ID → 箱マスタ.箱ID（逆参照）
- **初期値**:
  - 箱名 = CONCATENATE("箱", COUNT(箱マスタ[箱ID]) + 1)
  - 作成日 = TODAY()
  - ステータス = "箱詰済み"
  - 作成者 = USEREMAIL()
- **計算式**:
  - 箱詰商品数 = COUNT(SELECT(箱詰記録[箱詰ID], [箱ID] = [_THISROW].[箱ID]))
  - 配布済みフラグ = [ステータス] = "配布済み"
- **アクション**:
  - 配布完了時: ステータスを「配布済み」に更新、配布日・配布者を設定
- **バリデーション**:
  - 箱IDは一意
  - 配布日設定時はステータスが「箱詰済み」または「配布済み」
- **並び順**: 作成日 DESC

## ビジネスルール
1. 箱詰記録作成時に箱マスタに追加される
2. 箱は「箱詰済み」状態で作成される
3. 配布日を入力するとステータスが「配布済み」になる
4. 配布済みの箱は変更不可
5. 箱IDは「BOX-YYYY-XXX」形式で管理

## 他テーブルとの関係
- **箱詰記録**: 箱IDで紐付け（1対多）
- **在庫変動履歴**: 箱詰時の在庫減少記録と間接的に関連

## ビュー例
- 箱一覧ビュー（テーブルビュー）
- 配布待ち箱ビュー（フィルタ: ステータス = "箱詰済み"）
- 配布済み箱ビュー（フィルタ: ステータス = "配布済み"）
- 本日配布予定ビュー（配布予定日でフィルタ）
- 箱別商品詳細ビュー（箱詰記録との結合ビュー）

## ワークフロー
1. **箱詰作業**: 箱詰記録で商品を箱に詰める時に箱マスタが作成される（ステータス: 箱詰済み）
2. **配布**: 配布日を入力（ステータス: 配布済み）