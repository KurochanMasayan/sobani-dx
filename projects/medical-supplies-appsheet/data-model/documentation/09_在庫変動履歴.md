# 在庫変動履歴

## テーブル概要
- **テーブル名**: 在庫変動履歴
- **説明**: 全ての在庫変動を記録し、商品マスタの在庫数を自動更新する履歴テーブル
- **主キー**: 取引ID
- **役割**: 在庫変動のトランザクション記録と商品マスタへの在庫反映

## カラム定義

| カラム名 | 物理名 | データ型 | 必須 | 列種別 | 説明 |
|---------|--------|----------|------|--------|------|
| 取引ID | transaction_id | UniqueID | ✓ | 物理 | 一意識別子（自動生成） |
| 取引日時 | transaction_datetime | DateTime | ✓ | 物理 | 変動発生日時 |
| 商品ID | product_id | Ref | ✓ | 物理 | 対象商品（商品マスタ参照） |
| 取引タイプ | transaction_type | Enum | ✓ | 物理 | 入荷/配布/棚卸調整/廃棄/返品 |
| 変動個数 | change_pieces | Number | ✓ | 物理 | 変動個数（＋：増加、－：減少） |
| 変動箱数_表示 | change_boxes_display | Number | | 仮想 | 変動箱数表示（計算式: FLOOR([変動個数] / [箱入数])） |
| 関連ID | related_id | Text | | 物理 | 配布ID/入荷ID等 |
| 関連テーブル | related_table | Enum | | 物理 | 関連元（配布記録/入荷記録/手動） |
| 配布記録参照 | distribution_ref | Ref | | 仮想 | 配布記録への参照（計算式: IF([関連テーブル]="配布記録", [関連ID], "")） |
| 入荷記録参照 | receipt_ref | Ref | | 仮想 | 入荷記録への参照（計算式: IF([関連テーブル]="入荷記録", [関連ID], "")） |
| 関連レコード詳細 | related_detail | Text | | 仮想 | 関連情報（計算式: IF([関連テーブル]="配布記録", [配布記録参照].[配布ラベル], IF([関連テーブル]="入荷記録", CONCATENATE([入荷記録参照].[発注ID], " ", TEXT([入荷記録参照].[入荷日], "YYYY/MM/DD")), "手動入力"))） |
| 実行者 | executed_by | Email | ✓ | 物理 | 処理実行者 |
| 備考 | notes | Text | | 物理 | 変動理由等 |
| 商品名 | product_name | Text | | 仮想 | 商品名（計算式: [商品ID].[商品名]） |
| 箱入数 | pieces_per_box | Number | | 仮想 | 箱入数（計算式: [商品ID].[箱入数]） |
| 取引ラベル | transaction_label | Text | | 仮想 | ラベル（計算式: CONCATENATE(TEXT([取引日時], "YYYY/MM/DD HH:MM"), " ", [商品名], " ", [取引タイプ], " ", IF([変動個数] > 0, "+", ""), [変動個数], "個")） |

## 取引タイプの選択肢
- 入荷（＋）
- 箱詰（－）
- 配布（－）
- 在庫調整（±）
- 廃棄（－）
- 返品（－）

## AppSheet設定
- **ラベル**: [取引ラベル]
- **キー**: 取引ID
- **リレーション**: 商品ID → 商品マスタ.supply_id
- **初期値**:
  - 取引日時 = NOW()
  - 実行者 = USEREMAIL()
- **並び順**: 取引日時 DESC
- **読み取り専用**: TRUE（履歴は編集不可）

## 設計の考え方
- **個数単位で記録**: 全ての変動を個数単位で統一管理
- **在庫集計**: 商品マスタの現在在庫個数は在庫変動履歴から自動計算
- **符号による管理**: 入荷は＋、箱詰・配布・廃棄は－として記録
- **監査証跡**: いつ、誰が、何を、どれだけ変更したかの記録
- **箱詰処理**: 箱詰作業は在庫からの減算として記録（配布準備）
