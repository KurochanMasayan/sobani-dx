# 在庫変動履歴 (inventory_transactions)

## テーブル概要
- **テーブル名**: inventory_transactions
- **説明**: 全ての在庫変動を記録し、商品マスタの在庫数を自動更新する履歴テーブル
- **主キー**: 取引ID
- **役割**: 在庫変動のトランザクション記録と商品マスタへの在庫反映

## カラム定義

| カラム名 | 物理名 | データ型 | 必須 | 列種別 | 説明 |
|---------|--------|----------|------|--------|------|
| 取引ID | transaction_id | UniqueID | ✓ | 物理 | 一意識別子（自動生成） |
| 取引日時 | transaction_datetime | DateTime | ✓ | 物理 | 変動発生日時 |
| 商品ID | product_id | Ref | ✓ | 物理 | 対象商品（products参照） |
| 取引タイプ | transaction_type | Enum | ✓ | 物理 | 入荷/配布/棚卸調整/廃棄/返品 |
| 変動数量_箱 | change_boxes | Number | | 物理 | 変動箱数（＋：増加、－：減少） |
| 変動数量_個 | change_pieces | Number | | 物理 | 変動個数（＋：増加、－：減少） |
| 関連ID | related_id | Text | | 物理 | 配布ID/発注ID等 |
| 関連テーブル | related_table | Enum | | 物理 | 関連元（配布記録/発注管理/手動） |
| 配布記録参照 | distribution_ref | Ref | | 仮想 | 配布記録への参照（計算式: IF([関連テーブル]="配布記録", [関連ID], "")） |
| 発注管理参照 | purchase_ref | Ref | | 仮想 | 発注管理への参照（計算式: IF([関連テーブル]="発注管理", [関連ID], "")） |
| 関連レコード詳細 | related_detail | Text | | 仮想 | 関連情報（計算式: IF([関連テーブル]="配布記録", [配布記録参照].[配布ラベル], IF([関連テーブル]="発注管理", [発注管理参照].[発注番号], "手動入力"))） |
| 実行者 | executed_by | Email | ✓ | 物理 | 処理実行者 |
| 備考 | notes | Text | | 物理 | 変動理由等 |
| 商品名 | product_name | Text | | 仮想 | 商品名（計算式: [商品ID].[商品名]） |
| 箱入数 | pieces_per_box | Number | | 仮想 | 箱入数（計算式: [商品ID].[箱入数]） |
| 変動数量_合計個数 | total_change_pieces | Number | | 仮想 | 変動合計個数（計算式: ([変動数量_箱] * [箱入数]) + [変動数量_個]） |
| 取引ラベル | transaction_label | Text | | 仮想 | ラベル（計算式: CONCATENATE(TEXT([取引日時], "YYYY/MM/DD HH:MM"), " ", [商品名], " ", [取引タイプ], " ", IF([変動数量_合計個数] > 0, "+", ""), [変動数量_合計個数], "個")） |
| 現在在庫 | current_stock | Text | | 仮想 | 現在在庫（計算式: [商品ID].[在庫表示]） |

## 取引タイプの選択肢
- 入荷（＋）
- 配布（－）
- 棚卸調整（±）
- 廃棄（－）
- 返品（－）

## AppSheet設定
- **ラベル**: [取引ラベル]
- **キー**: 取引ID
- **リレーション**: 商品ID → products.product_id
- **初期値**:
  - 取引日時 = NOW()
  - 実行者 = USEREMAIL()
- **並び順**: 取引日時 DESC
- **読み取り専用**: TRUE（履歴は編集不可）

## 設計の考え方
- **変動数のみ記録**: 前後の在庫数は記録せず、変動数（差分）のみを記録
- **商品マスタ自動更新**: 在庫変動履歴の登録時に商品マスタの在庫数を自動更新
- **符号による管理**: 入荷は＋、配布・廃棄は－として記録
- **監査証跡**: いつ、誰が、何を、どれだけ変更したかの記録

## AppSheetアクション設定
- **在庫数更新アクション**:
  - トリガー: 在庫変動履歴の新規登録時
  - 処理内容:
    - 商品マスタの現在在庫_箱 += [変動数量_箱]
    - 商品マスタの現在在庫_個 += [変動数量_個]
    - 個数が箱入数を超えた場合、箱数に繰り上げ
    - 個数が負の場合、箱数から繰り下げ
  - 更新日時: 商品マスタの最終在庫更新を現在時刻に更新