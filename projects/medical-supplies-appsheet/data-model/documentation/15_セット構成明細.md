# セット構成明細

## テーブル概要

- **テーブル名**: セット構成明細
- **説明**: セットテンプレートマスタの構成商品を詳細管理
- **主キー**: 構成 ID
- **役割**: 各セットに含まれる医材と数量を定義

## カラム定義

| カラム名   | 物理名            | データ型 | 必須 | 列種別 | 説明                                                                                         |
| ---------- | ----------------- | -------- | ---- | ------ | -------------------------------------------------------------------------------------------- |
| 構成 ID    | composition_id    | UniqueID | ✓    | 物理   | 一意識別子（自動生成）                                                                       |
| セット ID  | set_template_id   | Ref      | ✓    | 物理   | セットテンプレートマスタ参照                                                                 |
| 商品 ID    | product_id        | Ref      | ✓    | 物理   | 商品マスタ参照                                                                               |
| 標準数量   | standard_quantity | Number   | ✓    | 物理   | セット 1 回分の標準数量                                                                      |
| 必須フラグ | is_required       | Yes/No   | ✓    | 物理   | 必須構成要素かどうか（デフォルト: TRUE）                                                     |
| 表示順     | display_order     | Number   |      | 物理   | 表示順序（デフォルト: 10）                                                                   |
| 備考       | notes             | LongText |      | 物理   | 代替品情報等の特記事項                                                                       |
| 作成者     | created_by        | Email    | ✓    | 物理   | 構成追加者                                                                                   |
| 作成日時   | created_at        | DateTime | ✓    | 物理   | 作成日時                                                                                     |
| セット名   | set_name          | Text     |      | 仮想   | セット名（計算式: [セット ID].[セット名]）                                                   |
| 商品名     | product_name      | Text     |      | 仮想   | 商品名（計算式: [商品 ID].[商品名]）                                                         |
| 単位       | unit              | Text     |      | 仮想   | 単位（計算式: [商品 ID].[単位]）                                                             |
| 現在在庫   | current_stock     | Number   |      | 仮想   | 現在在庫数（計算式: [商品 ID].[現在在庫個数]）                                               |
| 在庫状況   | stock_status      | Text     |      | 仮想   | 在庫状況（計算式: IF([現在在庫] >= [標準数量], "充分", IF([現在在庫] > 0, "不足", "なし"))） |
| 構成ラベル | composition_label | Text     |      | 仮想   | 表示用ラベル（計算式: CONCATENATE([商品名], " × ", [標準数量], [単位])）                     |

## AppSheet 設定

- **ラベル**: [構成ラベル]
- **キー**: 構成 ID
- **リレーション**:
  - セット ID → セットテンプレートマスタ.セット ID
  - 商品 ID → 商品マスタ.商品 ID
- **初期値**:
  - 必須フラグ = TRUE
  - 表示順 = 10
  - 作成者 = USEREMAIL()
  - 作成日時 = NOW()
- **計算式**:
  - セット名 = [セット ID].[セット名]
  - 商品名 = [商品 ID].[商品名]
  - 単位 = [商品 ID].[単位]
  - 現在在庫 = [商品 ID].[現在在庫個数]
  - 在庫状況 = IF([現在在庫] >= [標準数量], "充分", IF([現在在庫] > 0, "不足", "なし"))
  - 構成ラベル = CONCATENATE([商品名], " × ", [標準数量], [単位])
- **バリデーション**:
  - 標準数量 > 0
  - セット ID + 商品 ID の組み合わせで重複不可
- **条件付き書式**:
  - 在庫状況 = "なし" → 赤色
  - 在庫状況 = "不足" → 黄色
  - 必須フラグ = FALSE → グレー文字
- **並び順**: 表示順 ASC, 商品名 ASC

## ビジネスルール

1. 1 つのセットに同じ商品を複数登録不可
2. 必須商品は臨時配布時に在庫チェック対象
3. 非必須商品は在庫不足でも配布可能（警告表示）
4. 表示順により配布時の表示順序を制御
5. 商品マスタ削除時は該当構成も削除される

## 他テーブルとの関係

- **セットテンプレートマスタ**: 多対 1 の関係（構成 → セット）
- **商品マスタ**: 多対 1 の関係（構成 → 商品）

## ビュー例

- セット別構成一覧ビュー（テーブルビュー、セット ID でグループ化）
- 商品別使用セット一覧ビュー（商品 ID でグループ化）
- 在庫不足構成一覧ビュー（在庫状況でフィルタ）
- 構成商品編集ビュー（詳細ビュー）

## データ整合性チェック

- セット削除時の構成明細自動削除
- 商品削除時の構成明細自動削除
- 在庫不足アラート（必須商品のみ）

## 初期データ例

```csv
セットID,商品ID,標準数量,必須フラグ,表示順,備考
SET-001,PRD-001,1,TRUE,10,点滴バッグ（主要）
SET-001,PRD-002,1,TRUE,20,点滴ライン
SET-001,PRD-003,2,TRUE,30,アルコール綿
SET-001,PRD-004,1,FALSE,40,絆創膏（予備）
SET-002,PRD-005,1,TRUE,10,注射器20ml
SET-002,PRD-006,1,TRUE,20,注射針
SET-002,PRD-007,1,TRUE,30,抗生剤バイアル
```
