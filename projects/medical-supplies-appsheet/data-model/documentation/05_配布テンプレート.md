# 配布テンプレート

## テーブル概要
- **テーブル名**: 配布テンプレート
- **説明**: 患者ごとの定期的な医材配布パターンを管理
- **主キー**: テンプレートID

## カラム定義

| カラム名 | 物理名 | データ型 | 必須 | 列種別 | 説明 |
|---------|--------|----------|------|--------|------|
| テンプレートID | template_id | Text | ✓ | 物理 | 一意識別子（TMPL-XXX形式） |
| 施設ID | facility_id | Ref | ✓ | 物理 | 対象施設（facilities参照） |
| 患者ID | patient_id | Ref | | 物理 | 対象患者（patients参照） |
| 商品ID | product_id | Ref | ✓ | 物理 | 配布医材（商品マスタ参照） |
| 配布数量_偶数月 | quantity_even_month | Number | | 物理 | 偶数月の配布個数 |
| 配布数量_奇数月 | quantity_odd_month | Number | | 物理 | 奇数月の配布個数 |
| 配布頻度_日 | frequency_days | Number | | 物理 | 何日に1回配布 |
| 備考 | notes | Text | | 物理 | 特記事項 |
| 有効フラグ | is_active | Yes/No | ✓ | 物理 | 使用中/停止 |
| 施設名 | facility_name | Text | | 仮想 | 施設名（計算式: [施設ID].[施設名]） |
| 患者名 | patient_name | Text | | 仮想 | 患者名（計算式: IF(ISNOTBLANK([患者ID]), [患者ID].[フルネーム], "")） |
| 商品名 | product_name | Text | | 仮想 | 商品名（計算式: [商品ID].[商品名]） |
| 現在月の配布数量 | current_month_quantity | Number | | 仮想 | 今月の配布数量（計算式: IF(MOD(MONTH(TODAY()), 2) = 0, [配布数量_偶数月], [配布数量_奇数月])） |
| 月間配布回数 | monthly_frequency | Number | | 仮想 | 月間配布回数（計算式: IF([配布頻度_日] > 0, 30 / [配布頻度_日], 0)） |
| 月間必要数量 | monthly_required | Number | | 仮想 | 月間必要数量（計算式: [現在月の配布数量] * [月間配布回数]） |

## AppSheet設定
- **ラベル**: CONCATENATE([患者ID].[姓], " ", [患者ID].[名], " - ", [商品ID].[商品名])
- **キー**: テンプレートID
- **リレーション**:
  - 施設ID → 施設マスタ.facility_id
  - 患者ID → 患者マスタ.patient_id
  - 商品ID → 商品マスタ.supply_id
- **計算式**:
  - 月間配布数量 = IF(MOD(MONTH(TODAY()), 2) = 0, [配布数量_偶数月], [配布数量_奇数月])
- **フィルタ**: 有効フラグ = TRUE
