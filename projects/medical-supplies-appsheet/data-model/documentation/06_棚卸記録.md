# 棚卸記録

## テーブル概要
- **テーブル名**: 棚卸記録
- **説明**: 定期的な在庫確認と調整の記録
- **主キー**: 棚卸ID
- **役割**: 実在庫と帳簿在庫の差異調整、在庫精度の維持

## カラム定義

| カラム名 | 物理名 | データ型 | 必須 | 列種別 | 説明 |
|---------|--------|----------|------|--------|------|
| 棚卸ID | stocktaking_id | Text | ✓ | 物理 | 一意識別子（STK-YYYYMMDD-XXX形式） |
| 棚卸日 | stocktaking_date | Date | ✓ | 物理 | 棚卸実施日 |
| 商品ID | product_id | Ref | ✓ | 物理 | 商品（商品マスタ参照） |
| 実在庫_箱 | actual_stock_boxes | Number | ✓ | 物理 | 実際に確認した箱数 |
| 実在庫_個 | actual_stock_pieces | Number | ✓ | 物理 | 実際に確認した個数（端数） |
| 帳簿在庫_箱 | book_stock_boxes | Number | ✓ | 物理 | 棚卸時点の帳簿在庫（箱） |
| 帳簿在庫_個 | book_stock_pieces | Number | ✓ | 物理 | 棚卸時点の帳簿在庫（個） |
| 差異_箱 | diff_boxes | Number | ✓ | 物理 | 実在庫と帳簿在庫の差（箱） |
| 差異_個 | diff_pieces | Number | ✓ | 物理 | 実在庫と帳簿在庫の差（個） |
| 調整理由 | adjustment_reason | Text | | 物理 | 差異が発生した理由 |
| 実施者 | conducted_by | Text | ✓ | 物理 | 棚卸実施者名 |
| 承認者 | approved_by | Text | | 物理 | 棚卸結果承認者名 |
| 承認日時 | approved_at | DateTime | | 物理 | 承認日時 |
| ステータス | status | Enum | ✓ | 物理 | 実施中/承認待ち/承認済み/却下 |
| 備考 | notes | LongText | | 物理 | その他メモ |
| 商品名 | product_name | Text | | 仮想 | 商品名（計算式: [商品ID].[商品名]） |
| 実在庫合計 | actual_total | Number | | 仮想 | 実在庫合計個数（計算式: ([実在庫_箱] * [商品ID].[箱入数]) + [実在庫_個]） |
| 帳簿在庫合計 | book_total | Number | | 仮想 | 帳簿在庫合計個数（計算式: ([帳簿在庫_箱] * [商品ID].[箱入数]) + [帳簿在庫_個]） |
| 差異合計 | diff_total | Number | | 仮想 | 差異合計個数（計算式: [実在庫合計] - [帳簿在庫合計]） |
| 差異率 | diff_rate | Percent | | 仮想 | 差異率（計算式: IF([帳簿在庫合計] > 0, ABS([差異合計]) / [帳簿在庫合計], 0)） |

## AppSheet設定
- **ラベル**: CONCATENATE([商品名], " - ", TEXT([棚卸日]))
- **キー**: 棚卸ID
- **リレーション**: 商品ID → 商品マスタ.supply_id
- **初期値**:
  - 棚卸日 = TODAY()
  - 帳簿在庫_箱 = [商品ID].[現在在庫_箱]
  - 帳簿在庫_個 = [商品ID].[現在在庫_個]
  - ステータス = "実施中"
  - 実施者 = USEREMAIL()
- **計算式**:
  - 差異_箱 = [実在庫_箱] - [帳簿在庫_箱]
  - 差異_個 = [実在庫_個] - [帳簿在庫_個]
- **アクション**:
  - 承認時: 在庫管理テーブルの該当ロットを実在庫（箱・個）に更新し、必要に応じて箱⇔個の調整を実施
  - 承認時: 在庫変動履歴に「棚卸調整」として記録
- **バリデーション**:
  - 実在庫は0以上
  - 大きな差異（±20%以上）の場合は調整理由必須

## ビジネスルール
1. 棚卸は月1回実施を推奨
2. 差異が発生した場合は必ず理由を記録
3. 承認後に在庫管理テーブルの在庫箱数・在庫個数を自動更新し、個数がマイナスの場合は箱を1減らして端数を補正
4. 棚卸調整は在庫変動履歴に記録される
