# 訪問診療 医材在庫管理システム - データベース設計

## システム概要

訪問診療における医材の在庫管理を効率化するAppSheetアプリケーションのデータベース設計書です。

## 主要機能

1. **施設・患者管理**: 訪問先施設と患者情報の管理
2. **医材マスタ管理**: 取り扱い医材の基本情報と在庫数の一元管理
3. **配布テンプレート管理**: 患者別の定期配布パターン管理（偶数月・奇数月対応）
4. **医材配布記録**: 施設への配布実績管理
5. **在庫変動履歴**: すべての在庫変動をトランザクション記録
6. **棚卸記録**: 定期的な実地棚卸と在庫調整
7. **発注管理**: 発注申請・承認・納期管理
8. **入荷管理**: 発注に対する入荷記録（分割入荷対応）
9. **レポート機能**: 使用状況・在庫状況の可視化

## テーブル構成

| テーブル名 | 説明 | レコード想定数 |
|-----------|------|---------------|
| 施設マスタ | 施設マスタ | 50-100件 |
| 患者マスタ | 患者マスタ | 300-500件 |
| 商品マスタ | 商品マスタ（在庫管理含む） | 100-200件 |
| 発注先マスタ | 発注先マスタ | 5-10件 |
| 配布テンプレート | 配布テンプレート | 500-1000件 |
| 棚卸記録 | 棚卸記録 | 月100-200件 |
| 配布記録 | 配布記録 | 月1000件程度 |
| 発注管理 | 発注管理 | 月50件程度 |
| 入荷管理 | 入荷管理 | 月80件程度 |
| 在庫変動履歴 | 在庫変動履歴 | 月2000件程度 |

## データフロー

```
1. 基本設定
   施設マスタ → 患者マスタ → 配布テンプレート
   発注先マスタ → 商品マスタ (在庫数含む)

2. 日常業務
   配布テンプレート → 配布記録 → 在庫変動履歴
                                              ↓
                                          商品マスタ (在庫自動更新)
                                              ↓
                                          発注管理 (発注判定)
                                              ↓
                                         入荷管理 (入荷記録)
                                              ↓
                                          在庫変動履歴 (入荷記録)
                                              ↓
                                          商品マスタ (在庫自動更新)

3. 棚卸業務
   商品マスタ（総在庫数の集計） → 棚卸記録 (実地棚卸)
                              ↓
                        在庫変動履歴 (調整記録)
                              ↓
                          商品マスタ (在庫更新)
```

## 特徴的な仕様

### 偶数月・奇数月での配布数量変動
- distribution_templates テーブルで月別の配布数量を管理
- 現在月に応じて適切な数量を自動選択

### 箱単位と個数単位の併用
- 在庫は箱単位と個数単位の両方で管理
- 配布は個数単位で実施
- 商品マスタで在庫数を一元管理

### 定数在庫管理
- 商品マスタで定数在庫を管理し、在庫状況は在庫管理テーブルとの集計で確認
- 在庫状況は手動確認（不足アラートや自動推奨は無し）

### 在庫管理の一元化
- 商品マスタが在庫数のSingle Source of Truth
- 在庫変動履歴が全ての在庫変動を記録
- AppSheetアクションで自動的に在庫数を更新

## AppSheet実装上の考慮事項

1. **リレーション設計**
   - Ref型を使用して参照整合性を確保
   - ラベル表示で関連情報を見やすく表示

2. **計算フィールド**
   - 在庫数の自動計算

3. **条件付き書式**
   - 在庫不足の警告表示
   - 納期超過の強調表示

4. **アクション設計**
   - テンプレートからの一括配布
   - 在庫変動履歴登録時の商品マスタ集計更新
   - 棚卸承認時の在庫調整処理

5. **セキュリティ**
   - Email型でユーザー管理
   - 履歴テーブルは読み取り専用
