# 診療スケジュール

## 概要
訪問歯科診療の予定・実績を管理するトランザクションテーブル。
月間スケジュール管理と日次タイムスケジュールの両方をこのテーブルで統合管理する。

## テーブル定義

| カラム名 | データ型 | 必須 | 説明 |
|---------|---------|------|------|
| スケジュールID | Text | ○ | 自動採番（SCH-YYYYMMDD-NNN、例: SCH-20250125-001） |
| 訪問日 | Date | ○ | 訪問予定日 |
| 訪問開始時間 | Time | ○ | 開始時刻 |
| 訪問終了時間 | Time | | 終了時刻 |
| 患者ID | Ref | ○ | 患者マスタ参照 |
| 施設ID | Ref | | 施設マスタ参照（患者から自動取得も可） |
| 担当医師ID | Ref | | スタッフマスタ参照（役職=歯科医師のみ） |
| 担当衛生士ID | Ref | | スタッフマスタ参照（役職=歯科衛生士のみ） |
| 診療内容 | Text | | 口腔ケア、義歯調整、虫歯治療など |
| ステータス | Enum | ○ | 予定 / 完了 / キャンセル |
| 医師算定 | Yes/No | | 医師の居宅療養管理指導を算定するか |
| 衛生士算定 | Yes/No | | 衛生士の居宅療養管理指導を算定するか |
| 衛生士滞在時間 | Number | | 衛生士の滞在時間（分）※20分以上で算定可 |
| 診療メモ | LongText | | 診療後の記録（手書きメモからの転記） |
| 備考 | LongText | | その他メモ |
| 作成日時 | DateTime | | レコード作成日時（自動設定） |

## Enum定義

### ステータス
| 値 | 説明 |
|----|------|
| 予定 | 訪問予定（デフォルト） |
| 完了 | 訪問完了 |
| キャンセル | キャンセル済み |

## 仮想列（Virtual Columns）

### 関連情報の自動取得
| 仮想列名 | 計算式 | 説明 |
|---------|--------|------|
| 患者名 | [患者ID].[氏名] | 患者名を自動表示 |
| 施設名 | [施設ID].[施設名] | 施設名を自動表示 |
| 施設住所 | [施設ID].[住所] | 施設住所を自動表示 |
| 医師名 | [担当医師ID].[スタッフ名] | 担当医師名を自動表示 |
| 衛生士名 | [担当衛生士ID].[スタッフ名] | 担当衛生士名を自動表示 |

### 訪問No（日別通し番号）
| 仮想列名 | 計算式概要 | 説明 |
|---------|-----------|------|
| 訪問No | 同じ訪問日で自分より開始時間が早いレコード数 + 1 | AM/PM通しの連番（PDFテンプレートのNo.列に使用） |

```
COUNT(
  SELECT(
    診療スケジュール[スケジュールID],
    AND(
      [訪問日] = [_THISROW].[訪問日],
      [ステータス] <> "キャンセル",
      OR(
        [訪問開始時間] < [_THISROW].[訪問開始時間],
        AND(
          [訪問開始時間] = [_THISROW].[訪問開始時間],
          [作成日時] < [_THISROW].[作成日時]
        )
      )
    )
  )
) + 1
```
→ 同時刻が複数ある場合は作成日時の早い順で決定

### 算定判定
| 仮想列名 | 計算式概要 | 説明 |
|---------|-----------|------|
| 医師算定可能 | 患者の医師算定残り > 0 AND 担当医師IDが設定済み | 医師算定が可能かどうか |
| 衛生士算定可能 | 患者の衛生士算定残り > 0 AND 担当衛生士IDが設定済み AND (滞在時間 >= 20 OR 未入力) | 衛生士算定が可能かどうか |
| 20分警告 | 衛生士滞在時間 < 20 AND 衛生士滞在時間 > 0 | 20分未満の場合に警告表示 |

## リレーション

- **患者マスタ** ← 患者ID（多対1）
- **施設マスタ** ← 施設ID（多対1）
- **スタッフマスタ** ← 担当医師ID（多対1）
- **スタッフマスタ** ← 担当衛生士ID（多対1）

## ビジネスルール

### 算定ルール
1. **医師算定**：同一患者に対して月2回まで
2. **衛生士算定**：同一患者に対して月4回まで、かつ20分以上の滞在が必須
3. 訪問回数 > 算定上限の場合、どの訪問日で算定するか選択が必要

### 制約
- 担当医師IDには役職=歯科医師のスタッフのみ選択可能
- 担当衛生士IDには役職=歯科衛生士のスタッフのみ選択可能
- 衛生士算定=Yesの場合、衛生士滞在時間 >= 20が必要

## 使用例

### 月間スケジュール表示
```
フィルター：訪問日の年月 = 指定年月
グループ：患者ID
ソート：訪問日 ASC
```

### 本日のタイムスケジュール表示
```
フィルター：訪問日 = TODAY()
ソート：訪問開始時間 ASC
```

### 施設別スケジュール表示
```
フィルター：施設ID = 指定施設
ソート：訪問日, 訪問開始時間 ASC
```

### 算定アラート（月末確認用）
```
フィルター：
  患者の医師算定残り > 0 OR 患者の衛生士算定残り > 0
ソート：患者名 ASC
```
