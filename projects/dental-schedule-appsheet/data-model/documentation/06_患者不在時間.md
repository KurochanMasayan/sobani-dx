# 患者不在時間

## 概要

患者の定期的な不在時間（✕日時）を管理するマスタテーブル。
訪問診療スケジュール作成時に、患者が不在となる曜日・時間帯を参照し、スケジュールの衝突を防止する。

**1レコード = 1時間帯パターン** として管理し、曜日は **EnumList（複数選択）** で指定する。
例：「月・水・金 14:00-15:00」は1レコードで、曜日リストに「月,水,金」を設定する。

## テーブル定義

| カラム名 | データ型 | 必須 | 説明 |
|---------|---------|------|------|
| 不在時間ID | Text | ○ | 自動採番（ABS-NNN、例: ABS-001） |
| 患者ID | Ref | ○ | 患者マスタへの参照 |
| 曜日リスト | EnumList | ○ | 不在となる曜日を複数選択（月/火/水/木/金/土/日） |
| 終日フラグ | Yes/No | ○ | 終日不在かどうか（デフォルト: FALSE） |
| 開始時間 | Time | △ | 不在開始時間（終日フラグ=TRUEの場合は空） |
| 終了時間 | Time | △ | 不在終了時間（終日フラグ=TRUEの場合は空） |
| 不在理由 | Text | | 不在の理由（デイサービス、不在等） |
| 備考 | LongText | | その他メモ |

△ = 終日フラグ=FALSEの場合は必須

## EnumList定義

### 曜日リスト
| 値 | 説明 |
|----|------|
| 月 | 月曜日 |
| 火 | 火曜日 |
| 水 | 水曜日 |
| 木 | 木曜日 |
| 金 | 金曜日 |
| 土 | 土曜日 |
| 日 | 日曜日 |

AppSheetではチェックボックス形式で表示され、複数の曜日を選択可能。
Google Sheets上では「月,水,金」のようにカンマ区切りで保存される。

## リレーション

- **患者マスタ** ← 患者ID（多対1）
  - 1人の患者に対して複数の不在時間レコードが存在しうる
  - 各レコードは「同じ時間帯が適用される曜日グループ」を表す

## バリデーションルール

### 時間帯の必須チェック（開始時間・終了時間に設定）
```
IF(
  [終日フラグ] = FALSE,
  ISNOTBLANK([_THIS]),
  TRUE
)
```
→ 終日フラグがFALSEの場合、開始時間・終了時間は必須

### 時間の前後関係チェック（終了時間に設定）
```
IF(
  [終日フラグ] = FALSE,
  [開始時間] < [終了時間],
  TRUE
)
```
→ 開始時間は終了時間より前でなければならない

### 曜日リストの必須チェック
```
ISNOTBLANK([曜日リスト])
```
→ 最低1つの曜日を選択する必要がある

## 仮想列（Virtual Columns）

### 患者名（表示用）
```
[患者ID].[氏名]
```

### 時間帯表示
```
IF(
  [終日フラグ],
  "終日",
  TEXT([開始時間], "HH:MM") & " - " & TEXT([終了時間], "HH:MM")
)
```

### 曜日短縮表示（連続曜日を範囲表示）

連続する曜日を「月-金」のように範囲表示に変換する。
EnumListは定義順（月,火,水,木,金,土,日）で保存されるため、
長いパターンから順にSUBSTITUTEで置換し、残りのカンマを「・」に変換する。

```
SUBSTITUTE(
  SUBSTITUTE(
    SUBSTITUTE(
      SUBSTITUTE(
        SUBSTITUTE(
          SUBSTITUTE(
            SUBSTITUTE(
              SUBSTITUTE(
                SUBSTITUTE(
                  SUBSTITUTE(
                    SUBSTITUTE(
                      SUBSTITUTE(
                        SUBSTITUTE(
                          SUBSTITUTE(
                            SUBSTITUTE(
                              SUBSTITUTE(
                                [曜日リスト],
                                "月 , 火 , 水 , 木 , 金 , 土 , 日", "月-日"),
                              "月 , 火 , 水 , 木 , 金 , 土", "月-土"),
                            "火 , 水 , 木 , 金 , 土 , 日", "火-日"),
                          "月 , 火 , 水 , 木 , 金", "月-金"),
                        "火 , 水 , 木 , 金 , 土", "火-土"),
                      "水 , 木 , 金 , 土 , 日", "水-日"),
                    "月 , 火 , 水 , 木", "月-木"),
                  "火 , 水 , 木 , 金", "火-金"),
                "水 , 木 , 金 , 土", "水-土"),
              "木 , 金 , 土 , 日", "木-日"),
            "月 , 火 , 水", "月-水"),
          "火 , 水 , 木", "火-木"),
        "水 , 木 , 金", "水-金"),
      "木 , 金 , 土", "木-土"),
    "金 , 土 , 日", "金-日"),
  " , ", "・")
```

※ 3連続以上をダッシュ表示、2連続は「・」のまま

変換例:
| EnumList値 | 曜日短縮表示 |
|-----------|------------|
| 月 , 火 , 水 , 木 , 金 , 土 , 日 | 月-日 |
| 月 , 火 , 水 , 木 , 金 | 月-金 |
| 月 , 水 , 金 | 月・水・金 |
| 月 , 火 , 木 , 金 , 土 | 月・火・木-土 |
| 火 , 水 , 金 , 土 | 火・水・金・土 |
| 月 , 火 | 月・火 |
| 月 | 月 |

### 不在時間サマリ（表示用）
```
"(" & [曜日短縮表示] & ") " & [時間帯表示]
```
→ 表示例: 「(月-金) 14:00 - 15:00」「(火・金) 終日」「(月-日) 12:00 - 12:20」

## 診療スケジュールとの連携

### 診療スケジュールに追加する仮想列

#### 訪問日の曜日
```
SWITCH(
  WEEKDAY([訪問日]),
  1, "日",
  2, "月",
  3, "火",
  4, "水",
  5, "木",
  6, "金",
  7, "土"
)
```

#### 不在時間チェック（警告表示）
```
IF(
  ISNOTBLANK(
    SELECT(
      患者不在時間[不在時間ID],
      AND(
        [患者ID] = [_THISROW].[患者ID],
        IN([_THISROW].[訪問日の曜日], [曜日リスト]),
        OR(
          [終日フラグ] = TRUE,
          AND(
            [開始時間] < [_THISROW].[訪問終了時間],
            [終了時間] > [_THISROW].[訪問開始時間]
          )
        )
      )
    )
  ),
  "⚠️ 不在時間と重複",
  ""
)
```
→ IN() 関数でEnumListに訪問日の曜日が含まれるかチェック

#### 重複する不在時間の詳細表示
```
IF(
  ISNOTBLANK([不在時間チェック]),
  CONCATENATE(
    SELECT(
      患者不在時間[不在時間サマリ],
      AND(
        [患者ID] = [_THISROW].[患者ID],
        IN([_THISROW].[訪問日の曜日], [曜日リスト]),
        OR(
          [終日フラグ] = TRUE,
          AND(
            [開始時間] < [_THISROW].[訪問終了時間],
            [終了時間] > [_THISROW].[訪問開始時間]
          )
        )
      )
    )
  ),
  ""
)
```
→ 警告が出た場合に、具体的にどの不在パターンと重複しているかを表示

### 患者マスタに追加する仮想列

#### 不在時間一覧（参照用・改行区切り）
```
SUBSTITUTE(
  CONCATENATE(
    SELECT(
      患者不在時間[不在時間サマリ],
      [患者ID] = [_THISROW].[ID]
    )
  ),
  " , ",
  CHAR(10)
)
```
→ 患者詳細画面で全不在時間を一覧表示（PDFテンプレートで改行表示される）

## アクション

### 別の時間帯を追加（複製アクション）

既存の不在時間レコードをコピーして、時間帯だけ変更して新規レコードを作成する。
同じ患者の別の不在パターンをすばやく追加するために使用。

- Action name: 別の時間帯を追加
- For a record of: 患者不在時間
- Do this: Data: add a new row to this table using values from this row
- Set columns:
  - 不在時間ID = CONCATENATE("ABS-", TEXT(RANDBETWEEN(1,999), "000"))
  - 患者ID = [患者ID]
  - 曜日リスト = [曜日リスト]
  - 終日フラグ = FALSE
  - 開始時間 = ""
  - 終了時間 = ""
  - 不在理由 = ""
  - 備考 = ""
- Prominence: Display prominently

→ 同じ患者・同じ曜日パターンで別の時間帯を追加する場合に便利

## ビュー

### 患者別不在時間一覧

- Type: Table
- Data: 患者不在時間
- Group by: [患者名]
- Sort: [患者ID] ASC, [開始時間] ASC
- Columns: 患者名, 曜日リスト, 時間帯表示, 不在理由

### 患者詳細画面のインラインリスト

患者マスタの詳細画面（Detail View）に、Related 患者不在時間 のインラインリストを表示。
患者情報を見ながら、不在時間の追加・編集・削除が可能。

## データ件数

現在48件が登録済み（19名の患者分）

## 設計上の注意点

### EnumList方式の採用理由

| 観点 | 正規化方式（1曜日=1レコード） | EnumList方式（採用） |
|------|--------------------------|---------------------|
| レコード数 | 109件 | **48件** |
| データ入力 | 曜日ごとに1件ずつ入力 | **チェックボックスで複数曜日を選択** |
| 一覧性 | 同じ時間帯が曜日数だけ分散 | **「月・水・金 14:00-15:00」と1行表示** |
| 曜日の変更 | レコード削除+追加 | **チェックの付け外し** |
| クエリ | `[曜日] = "月"` | `IN("月", [曜日リスト])` |

### データ品質に関する注記

元データの一部に破損が見られた箇所がある:
- No.15 中村明子: 「15:00 - 15:3:30 - 14:30」→「15:00 - 15:30」と解釈（要確認）
- No.31 井川容子: 月曜の12:30-15:00と14:30-15:00が重複 → 広い方（12:30-15:00）を採用

### 未登録患者

以下の患者IDは現在の患者マスタに未登録のため、追加が必要:
- No.62 谷角新吾（不在時間データあり）
- No.58 西田哲、No.61 村口史老、No.63 加藤多津子、No.64 中村靜子（不在時間データなし）
