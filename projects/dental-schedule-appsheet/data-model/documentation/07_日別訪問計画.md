# 日別訪問計画

## 概要

特定の日の訪問診療スケジュール全体を管理するテーブル。
AppSheetのPDFテンプレート機能でタイムスケジュールPDFを出力する際の**起点レコード**として使用する。

AppSheetのPDFテンプレートは「1レコード → 1PDF」の仕組みのため、
「ある日のスケジュール一覧PDF」を生成するには、日付単位のレコードが必要となる。

## テーブル定義

| カラム名 | データ型 | 必須 | 説明 |
|---------|---------|------|------|
| 計画ID | Text | ○ | 自動採番（PLAN-YYYYMMDD、例: PLAN-20250120） |
| 訪問日 | Date | ○ | 対象日（PDFヘッダーに表示される日付） |
| ステータス | Enum | ○ | 作成済み / 印刷済み / 提出済み（デフォルト: 作成済み） |
| PDF作成日時 | DateTime | | PDFを生成した日時（レコード追加時に自動設定） |
| 備考 | LongText | | その日全体のメモ（天候・交通情報・特記事項など） |

## Enum定義

### ステータス
| 値 | 説明 |
|----|------|
| 作成済み | PDFが生成された直後の状態（デフォルト） |
| 印刷済み | PDFを印刷した |
| 提出済み | 印刷物をスタッフに渡した |

## リレーション

診療スケジュールテーブルとは直接のRef関係を持たず、**訪問日の一致**で関連付ける。

```
日別訪問計画（訪問日: 2025/01/20）
  │
  │ [訪問日] = [_THISROW].[訪問日] でフィルタ
  ▼
診療スケジュール
  ├── SCH-20250120-001（09:00〜 患者A）
  ├── SCH-20250120-002（09:45〜 患者B）
  └── SCH-20250120-003（10:30〜 患者C）
```

PDFテンプレートの `<<Start>>` `<<End>>` タグ内で、訪問日をフィルタ条件にして
診療スケジュールのレコードをループ表示する。

## 仮想列（Virtual Columns）

### AM件数
```
COUNT(
  SELECT(
    診療スケジュール[スケジュールID],
    AND(
      [訪問日] = [_THISROW].[訪問日],
      [訪問開始時間] < "12:00:00",
      [ステータス] <> "キャンセル"
    )
  )
)
```

### PM件数
```
COUNT(
  SELECT(
    診療スケジュール[スケジュールID],
    AND(
      [訪問日] = [_THISROW].[訪問日],
      [訪問開始時間] >= "12:00:00",
      [ステータス] <> "キャンセル"
    )
  )
)
```

### 合計件数
```
[AM件数] + [PM件数]
```

### スケジュール概要（一覧表示用）
```
TEXT([訪問日], "YYYY/MM/DD") & "（" &
SWITCH(
  WEEKDAY([訪問日]),
  1, "日", 2, "月", 3, "火", 4, "水", 5, "木", 6, "金", 7, "土"
) & "） " & [合計件数] & "件"
```
→ 表示例: 「2025/01/20（月） 3件」

### AM訪問（List型・PDFテンプレート用）
```
SELECT(
  診療スケジュール[スケジュールID],
  AND(
    [訪問日] = [_THISROW].[訪問日],
    [訪問開始時間] < "12:00:00",
    [ステータス] <> "キャンセル"
  )
)
```
→ AM件数のSELECTと同じ条件（COUNTなし）。PDFテンプレートの `<<Start: ORDERBY(...)>>` で使用

### PM訪問（List型・PDFテンプレート用）
```
SELECT(
  診療スケジュール[スケジュールID],
  AND(
    [訪問日] = [_THISROW].[訪問日],
    [訪問開始時間] >= "12:00:00",
    [ステータス] <> "キャンセル"
  )
)
```
→ PM件数のSELECTと同じ条件（COUNTなし）。PDFテンプレートの `<<Start: ORDERBY(...)>>` で使用

## ビュー

### 訪問計画一覧

- Type: Table
- Data: 日別訪問計画
- Sort: [訪問日] DESC
- Columns: 訪問日, スケジュール概要, AM件数, PM件数, 合計件数, ステータス
- Group by: なし

### 訪問計画カレンダー

- Type: Calendar
- Data: 日別訪問計画
- Start: [訪問日]
- End: [訪問日]
- Description: [スケジュール概要]

## アクション

### タイムスケジュールPDF生成（レコード追加時に自動実行）

レコード追加時にPDFを自動生成するイベントアクション。
詳細は [03_PDFテンプレート設計書](../../documents/03_PDFテンプレート設計書.md) を参照。

- Event: Adds only
- Table: 日別訪問計画
- Do this: App: create a file for this row with a template
- Template: タイムスケジュールテンプレート（Google Docs）
- File name prefix: CONCATENATE("タイムスケジュール_", TEXT([訪問日], "YYYYMMDD"))

### 印刷済みにする

- Action name: 印刷済みにする
- For a record of: 日別訪問計画
- Do this: Data: set the values of some columns
- Set: ステータス = "印刷済み"
- Only if: [ステータス] = "作成済み"
- Prominence: Display prominently

### 提出済みにする

- Action name: 提出済みにする
- For a record of: 日別訪問計画
- Do this: Data: set the values of some columns
- Set: ステータス = "提出済み"
- Only if: [ステータス] = "印刷済み"
- Prominence: Display prominently

## データ件数

デモデータとして6件を用意（既存の診療スケジュールデモデータに対応する日付）。
