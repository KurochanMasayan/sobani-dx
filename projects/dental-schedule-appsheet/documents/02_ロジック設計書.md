# 歯科診療スケジュール管理システム ロジック設計書

## 1. 業務フロー分析

### 1.1 月次業務フロー

```
┌─────────────────────────────────────────────────────────────────┐
│                        月初                                      │
├─────────────────────────────────────────────────────────────────┤
│  1. 前月スケジュールを参考に当月スケジュール案を作成              │
│  2. 患者マスタの「訪問頻度」「曜日」を参考にベース日程を設定      │
│  3. 治療の進行状況に応じてイレギュラー調整                        │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        日々の運用                                │
├─────────────────────────────────────────────────────────────────┤
│  1. 当日のスケジュールを確認                                     │
│  2. 医師/衛生士が訪問、診療実施                                  │
│  3. 帰院後、診療記録を更新                                       │
│  4. 算定フラグを設定（どの訪問で算定するか決定）                  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        月末                                      │
├─────────────────────────────────────────────────────────────────┤
│  1. 算定状況の確認（上限まで算定できているか）                    │
│  2. 算定漏れがあれば、残りの訪問で算定フラグを設定                │
│  3. レセプト（請求）作成用のデータ出力                            │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 訪問と算定の関係

**重要な概念：「訪問」と「算定」は別物**

```
例：患者Aさんへの月間訪問

  訪問1回目 (1/5)   → 医師算定 ○
  訪問2回目 (1/12)  → 医師算定 ○、衛生士算定 ○（25分滞在）
  訪問3回目 (1/19)  → 算定なし（医師は上限到達）、衛生士算定 ○（30分滞在）
  訪問4回目 (1/26)  → 衛生士算定 ○（20分滞在）
  訪問5回目 (1/30)  → 算定なし（緊急対応、治療のみ）

  結果：訪問5回、医師算定2回、衛生士算定3回
```

---

## 2. 算定ルール詳細

### 2.1 居宅療養管理指導とは

介護保険サービスの一つ。医師、歯科医師、薬剤師、歯科衛生士などが患者の居宅を訪問し、療養上の管理・指導を行うサービス。

### 2.2 歯科医師の算定ルール

| 項目 | 内容 |
|------|------|
| 算定上限 | **月2回まで** |
| 条件 | 訪問診療を実施すること |
| 点数 | 単一建物居住者の人数により異なる |

**算定判定ロジック：**
```
IF 当月の医師算定回数 < 2 THEN
    算定可能
ELSE
    算定不可（上限到達）
```

### 2.3 歯科衛生士の算定ルール

| 項目 | 内容 |
|------|------|
| 算定上限 | **月4回まで** |
| 条件① | 1回あたり**20分以上**の滞在 |
| 条件② | 歯科医師の指示に基づく実地指導 |
| 点数 | 単一建物居住者の人数により異なる |

**算定判定ロジック：**
```
IF 当月の衛生士算定回数 < 4 AND 滞在時間 >= 20分 THEN
    算定可能
ELSE IF 当月の衛生士算定回数 >= 4 THEN
    算定不可（上限到達）
ELSE IF 滞在時間 < 20分 THEN
    算定不可（20分未満）
```

### 2.4 衛生士の二軸管理

**課題：** 衛生士が20分以上滞在するためには、スケジュール上の制約がある

```
【例：衛生士Aの1日のスケジュール】

09:00 施設X 患者1（20分）→ 09:20終了
09:20 施設X 患者2（20分）→ 09:40終了  ※同じ施設なので連続可能
09:40 移動（30分）
10:10 施設Y 患者3（20分）→ 10:30終了
10:30 移動（45分）
11:15 施設Z 患者4（20分）→ 11:35終了

→ 4患者を診るのに2時間35分必要
→ 移動時間により、物理的に20分確保できない場合がある
```

**二軸の意味：**
1. **衛生士軸**：衛生士の移動・滞在スケジュール
2. **患者軸**：患者ごとの訪問予定・算定状況

---

## 3. データモデル設計

### 3.1 テーブル一覧

```
┌─────────────────────────────────────────────────────────────────┐
│                      マスタテーブル                              │
├─────────────────────────────────────────────────────────────────┤
│  1. 施設マスタ（FAC001〜）           ← 既存                      │
│  2. 患者マスタ                        ← 既存                      │
│  3. 居宅介護支援事業所マスタ（CMP001〜）← 既存                    │
│  4. スタッフマスタ（STF001〜）        ← 新規                      │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                  トランザクションテーブル                        │
├─────────────────────────────────────────────────────────────────┤
│  5. 診療スケジュール（SCH-YYYYMMDD-NNN）← 新規                   │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 スタッフマスタ（新規）

| カラム名 | データ型 | 必須 | 説明 |
|---------|---------|------|------|
| スタッフID | Text | ○ | STF + 3桁連番（例：STF001） |
| スタッフ名 | Text | ○ | 氏名 |
| 役職 | Enum | ○ | 歯科医師 / 歯科衛生士 |
| 電話番号 | Phone | | 連絡先 |
| 稼働曜日 | Text | | 月火水木金 など |
| 備考 | LongText | | |

### 3.3 診療スケジュール（新規）

| カラム名 | データ型 | 必須 | 説明 |
|---------|---------|------|------|
| スケジュールID | Text | ○ | SCH-YYYYMMDD-NNN（自動採番） |
| 訪問日 | Date | ○ | 訪問予定日 |
| 訪問開始時間 | Time | ○ | 開始時刻 |
| 訪問終了時間 | Time | | 終了時刻 |
| 患者ID | Ref | ○ | 患者マスタ参照 |
| 施設ID | Ref | | 施設マスタ参照（患者から自動取得可） |
| 担当医師ID | Ref | | スタッフマスタ参照（役職=歯科医師） |
| 担当衛生士ID | Ref | | スタッフマスタ参照（役職=歯科衛生士） |
| 診療内容 | Text | | 口腔ケア、義歯調整、虫歯治療など |
| ステータス | Enum | ○ | 予定 / 完了 / キャンセル |
| 医師算定 | Yes/No | | 医師の居宅療養管理指導を算定するか |
| 衛生士算定 | Yes/No | | 衛生士の居宅療養管理指導を算定するか |
| 衛生士滞在時間 | Number | | 衛生士の滞在時間（分） |
| 診療メモ | LongText | | 診療後の記録 |
| 備考 | LongText | | |

---

## 4. 計算ロジック（Virtual Columns）

### 4.1 患者マスタに追加する仮想列

```
【当月訪問回数】
COUNT(
  SELECT(診療スケジュール[スケジュールID],
    AND(
      [患者ID] = [_THISROW].[ID],
      MONTH([訪問日]) = MONTH(TODAY()),
      YEAR([訪問日]) = YEAR(TODAY()),
      [ステータス] <> "キャンセル"
    )
  )
)

【当月医師算定回数】
COUNT(
  SELECT(診療スケジュール[スケジュールID],
    AND(
      [患者ID] = [_THISROW].[ID],
      [医師算定] = TRUE,
      MONTH([訪問日]) = MONTH(TODAY()),
      YEAR([訪問日]) = YEAR(TODAY())
    )
  )
)

【当月衛生士算定回数】
COUNT(
  SELECT(診療スケジュール[スケジュールID],
    AND(
      [患者ID] = [_THISROW].[ID],
      [衛生士算定] = TRUE,
      MONTH([訪問日]) = MONTH(TODAY()),
      YEAR([訪問日]) = YEAR(TODAY())
    )
  )
)

【医師算定残り】
MAX(0, 2 - [当月医師算定回数])

【衛生士算定残り】
MAX(0, 4 - [当月衛生士算定回数])

【算定ステータス】
IF(
  AND([医師算定残り] = 0, [衛生士算定残り] = 0),
  "算定完了",
  CONCATENATE(
    IF([医師算定残り] > 0, "医師残" & [医師算定残り] & "回 ", ""),
    IF([衛生士算定残り] > 0, "衛生士残" & [衛生士算定残り] & "回", "")
  )
)
```

### 4.2 診療スケジュールに追加する仮想列

```
【施設名】（患者から自動取得）
LOOKUP([患者ID], 患者マスタ, ID, 施設ID)
→ さらに施設マスタから施設名を取得

【医師算定可能】
AND(
  [担当医師ID] <> "",
  LOOKUP([患者ID], 患者マスタ, ID, 医師算定残り) > 0
)

【衛生士算定可能】
AND(
  [担当衛生士ID] <> "",
  LOOKUP([患者ID], 患者マスタ, ID, 衛生士算定残り) > 0,
  OR([衛生士滞在時間] >= 20, ISBLANK([衛生士滞在時間]))
)

【20分警告】
IF(
  AND([担当衛生士ID] <> "", [衛生士滞在時間] < 20, [衛生士滞在時間] > 0),
  "⚠️ 20分未満",
  ""
)
```

---

## 5. 画面・ビュー設計

### 5.1 メイン画面構成

```
┌─────────────────────────────────────────────────────────────────┐
│  歯科診療スケジュール管理                                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [本日のスケジュール]  [月間カレンダー]  [算定管理]  [マスタ管理] │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 ビュー（Slice）定義

| ビュー名 | フィルター条件 | ソート | 用途 |
|---------|---------------|--------|------|
| 本日のスケジュール | 訪問日 = TODAY() | 訪問開始時間 ASC | 当日の訪問一覧 |
| 今週のスケジュール | 訪問日 が今週 | 訪問日, 訪問開始時間 | 週間表示 |
| 施設別スケジュール | 指定施設ID | 訪問日, 訪問開始時間 | 施設単位での確認 |
| 患者別スケジュール | 指定患者ID | 訪問日 DESC | 患者の訪問履歴 |
| 算定アラート | 医師算定残り > 0 OR 衛生士算定残り > 0 | 患者名 | 算定枠が残っている患者 |
| 算定済み一覧 | 医師算定=TRUE OR 衛生士算定=TRUE | 訪問日 | 当月の算定記録 |

### 5.3 アクション定義

| アクション名 | 動作 | トリガー |
|-------------|------|---------|
| 医師算定ON | 医師算定フラグをTRUEに | ボタン |
| 衛生士算定ON | 衛生士算定フラグをTRUEに（20分チェック付き） | ボタン |
| スケジュール複製 | 選択したスケジュールを翌週/翌月に複製 | ボタン |
| 完了にする | ステータスを「完了」に変更 | ボタン |

---

## 6. 二重入力問題の解決

### 6.1 現状の問題

```
【現状】
┌─────────────────┐     ┌─────────────────┐
│ 診療スケジュール │     │ タイムスケジュール│
│   （月間管理）   │     │   （日次管理）   │
└────────┬────────┘     └────────┬────────┘
         │                       │
         │    同じ情報を        │
         │    二重入力          │
         ▼                       ▼
    手動で転記 ←─────────────────┘
```

### 6.2 解決後

```
【解決後】
┌─────────────────────────────────────┐
│         診療スケジュール             │
│        （統合管理テーブル）          │
└──────────────┬──────────────────────┘
               │
    ┌──────────┴──────────┐
    ▼                     ▼
┌─────────┐         ┌─────────┐
│月間表示 │         │日次表示 │
│ビュー   │         │ビュー   │
└─────────┘         └─────────┘

入力は1回だけ → 表示形式を切り替えるだけ
```

---

## 7. 今後の拡張検討

### 7.1 定期スケジュール自動生成

患者マスタの「訪問頻度」「曜日」から、月間スケジュールを一括生成する機能

```
【例】
患者A：訪問頻度=月2、曜日=水
→ 当月の第2水曜、第4水曜に自動でスケジュール作成
```

### 7.2 移動時間の自動計算

施設マスタの住所から、施設間の移動時間を概算

```
【例】
施設A → 施設B：車で30分
→ 施設Aの終了時間 + 30分 = 施設Bの開始可能時間
```

### 7.3 レセプト出力連携

算定記録から、レセプト（診療報酬請求）用のCSV出力

```
出力項目：
- 患者情報
- 算定日
- 算定区分（医師/衛生士）
- 単一建物居住者数
- 点数
```
