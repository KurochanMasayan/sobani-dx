# タイムスケジュールPDF テンプレート設計書

## 1. 概要

AppSheetのPDFテンプレート機能（Google Docs）を使い、日毎の訪問診療スケジュールをPDFとして出力する。

### 出力イメージ

```
2026/02/27（木）

┌────┬──────────┬──────────┬──────────────┬──────────┬───────────────────┬──────┐
│No. │ 施設名    │ 氏名     │ 自己負担有無  │ 時間     │ ×日時             │ 備考 │
│    │          │          │ 要介護度     │ 所要時間  │                   │      │
├────┴──────────┴──────────┴──────────────┴──────────┴───────────────────┴──────┤
│ AM                                                                           │
├────┬──────────┬──────────┬──────────────┬──────────┬───────────────────┬──────┤
│ 1  │あさひ新琴似│ 井川 容子 │ 無           │          │(木) 9:30-10:00    │      │
│    │          │          │ 要介護5      │          │(月・水・金) 12:30- │      │
│    │          │          │              │          │15:00 ...          │      │
├────┼──────────┼──────────┼──────────────┼──────────┼───────────────────┼──────┤
│ 2  │わだ家     │ 小清水 健次│ 有(障害/初診 │          │                   │      │
│    │          │          │  料のみ)     │          │                   │      │
│    │          │          │ 要介護4      │          │                   │      │
├────┴──────────┴──────────┴──────────────┴──────────┴───────────────────┴──────┤
│ PM                                                                           │
├────┬──────────┬──────────┬──────────────┬──────────┬───────────────────┬──────┤
│ 6  │ディールエン│ 佐藤 登美子│ 無          │          │(火・水・金)       │      │
│    │ハイス     │          │ 要介護3      │          │ 15:00-16:00       │      │
└────┴──────────┴──────────┴──────────────┴──────────┴───────────────────┴──────┘
```

- **時間・所要時間列**: 印刷後に手書きで記入する想定のため空白
- **×日時列**: 患者不在時間テーブルのデータを自動表示
- **AM/PM**: 訪問開始時間が12:00前/後で自動分割

---

## 2. 前提条件

### 2.1 日別訪問計画テーブル（新規作成）

PDFテンプレートの起点レコードとなるテーブル。
詳細は [07_日別訪問計画.md](../data-model/documentation/07_日別訪問計画.md) を参照。

| カラム名 | データ型 | Key | 説明 |
|---------|---------|-----|------|
| 計画ID | Text | ○ | PLAN-YYYYMMDD |
| 訪問日 | Date | | PDFの対象日 |
| ステータス | Enum | | 作成済み / 印刷済み / 提出済み（デフォルト: 作成済み） |
| PDF作成日時 | DateTime | | PDF生成日時（レコード追加時に自動設定） |
| 備考 | LongText | | |

### 2.2 追加が必要な仮想列

#### 診療スケジュールテーブルに追加

PDFテンプレート内で参照するために、以下の仮想列を追加する。

| 仮想列名 | 計算式 | 説明 |
|---------|--------|------|
| 患者自己負担有無 | `[患者ID].[自己負担有無]` | 患者の自己負担有無 |
| 患者要介護度 | `[患者ID].[要介護度]` | 患者の要介護度 |
| 患者不在時間一覧 | `[患者ID].[不在時間一覧]` | 患者の全不在時間（改行区切り） |

#### 患者マスタの不在時間一覧を改行区切りに変更

PDFで改行表示されるように、区切り文字をカンマから改行に変更する。

**変更前:**
```
CONCATENATE(
  SELECT(
    患者不在時間[不在時間サマリ],
    [患者ID] = [_THISROW].[ID]
  )
)
```

**変更後:**
```
SUBSTITUTE(
  CONCATENATE(
    SELECT(
      患者不在時間[不在時間サマリ],
      [患者ID] = [_THISROW].[ID]
    )
  ),
  " , ",
  CHAR(10)
)
```
→ 「月・水・金 14:00 - 15:00」と「火 13:00 - 14:00」が改行で区切られる

#### 患者不在時間の不在時間サマリを括弧付き形式に変更

出力イメージに合わせ、曜日を括弧で囲む。

**変更前:**
```
SUBSTITUTE([曜日リスト], ",", "・") & " " & [時間帯表示]
```

**変更後:**
```
"(" & SUBSTITUTE([曜日リスト], ",", "・") & ") " & [時間帯表示]
```
→ 表示例: 「(月・水・金) 14:00 - 15:00」「(火) 終日」

---

## 3. Google Docsテンプレートの作成

### 3.1 テンプレートファイルの準備

1. Google Driveで新規Google Docsを作成
2. ファイル名: `タイムスケジュールテンプレート`
3. ページ設定: **横向き（Landscape）、A4**
4. 余白: 上下左右すべて **1.0cm**（狭め推奨）

### 3.2 テンプレート全体像

Google Docsに記述する内容の全体像。実際にDocsに入力する文字列をそのまま示す。

```
<<[訪問日]>>

┌──────────────────────────────── テーブル（7列） ────────────────────────────────┐
│                                                                                │
│  [ヘッダー行1]  No. │ 施設名 │ 氏名 │ 自己負担有無 │ 時間   │ ×日時 │ 備考   │
│  [ヘッダー行2]      │        │      │ 要介護度    │ 所要時間│       │        │
│  [AMラベル行]   AM  │（B〜G列を結合して空白）                                  │
│  [AMデータ行1]  <<Start: ORDERBY([AM訪問], [訪問開始時間], FALSE, [作成日時], FALSE)>>        │
│                     │ <<[施設名]>> │ <<[患者名]>> │ <<[患者自己負担有無]>> │ │ <<[患者不在時間一覧]>> │ <<[備考]>> │
│  [AMデータ行2]      │              │              │ <<[患者要介護度]>>     │ │                       │ <<End>>    │
│  [PMラベル行]   PM  │（B〜G列を結合して空白）                                  │
│  [PMデータ行1]  <<Start: ORDERBY([PM訪問], [訪問開始時間], FALSE, [作成日時], FALSE)>>        │
│                     │ <<[施設名]>> │ <<[患者名]>> │ <<[患者自己負担有無]>> │ │ <<[患者不在時間一覧]>> │ <<[備考]>> │
│  [PMデータ行2]      │              │              │ <<[患者要介護度]>>     │ │                       │ <<End>>    │
│                                                                                │
└────────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 セルごとの記述内容

#### ヘッダー部分（テーブルの外）

テーブルの上に以下のテキストを配置:

```
<<[訪問日]>>
```

#### ヘッダー行（行1-2）

| 列 | 行1 | 行2 | セル結合 |
|----|-----|-----|---------|
| A | `No.` | | A1-A2 縦結合 |
| B | `施設名` | | B1-B2 縦結合 |
| C | `氏名` | | C1-C2 縦結合 |
| D | `自己負担有無` | `要介護度` | 結合しない |
| E | `時間` | `所要時間` | 結合しない |
| F | `×日時` | | F1-F2 縦結合 |
| G | `備考` | | G1-G2 縦結合 |

#### AMラベル行（行3）

| 列 | 内容 | セル結合 |
|----|------|---------|
| A | `AM` | A-G 横結合（1行全体を結合） |

#### AMデータ行（行4-5） ※ <<Start>>〜<<End>> で囲む

| 列 | 行4（上段） | 行5（下段） | セル結合 |
|----|------------|------------|---------|
| A | `<<Start: ORDERBY([AM訪問], [訪問開始時間], FALSE, [作成日時], FALSE)>>` | | A4-A5 縦結合 |
| B | `<<[施設名]>>` | | B4-B5 縦結合 |
| C | `<<[患者名]>>` | | C4-C5 縦結合 |
| D | `<<[患者自己負担有無]>>` | `<<[患者要介護度]>>` | 結合しない |
| E | | | 結合しない（手書き用空白） |
| F | `<<[患者不在時間一覧]>>` | | F4-F5 縦結合 |
| G | `<<[備考]>>` | `<<End>>` | 結合しない |

**注意:** `<<Start: ...>>` タグはAMデータの最初のセル（A4）に配置。`<<End>>` はAMデータの最後のセル（G5）に配置。

#### PMラベル行（行6）

| 列 | 内容 | セル結合 |
|----|------|---------|
| A | `PM` | A-G 横結合（1行全体を結合） |

#### PMデータ行（行7-8） ※ <<Start>>〜<<End>> で囲む

| 列 | 行7（上段） | 行8（下段） | セル結合 |
|----|------------|------------|---------|
| A | `<<Start: ORDERBY([PM訪問], [訪問開始時間], FALSE, [作成日時], FALSE)>>` | | A7-A8 縦結合 |
| B | `<<[施設名]>>` | | B7-B8 縦結合 |
| C | `<<[患者名]>>` | | C7-C8 縦結合 |
| D | `<<[患者自己負担有無]>>` | `<<[患者要介護度]>>` | 結合しない |
| E | | | 結合しない（手書き用空白） |
| F | `<<[患者不在時間一覧]>>` | | F7-F8 縦結合 |
| G | `<<[備考]>>` | `<<End>>` | 結合しない |

### 3.4 セル結合まとめ

```
        A列    B列    C列    D列      E列      F列    G列
行1-2   ┃結合  ┃結合  ┃結合  │個別    │個別    ┃結合  ┃結合   ← ヘッダー
行3      ━━━━━━━━━━━━━━━━━━ 全列結合 ━━━━━━━━━━━━━━━━━━   ← AM
行4-5   ┃結合  ┃結合  ┃結合  │個別    │個別    ┃結合  │個別   ← AMデータ
行6      ━━━━━━━━━━━━━━━━━━ 全列結合 ━━━━━━━━━━━━━━━━━━   ← PM
行7-8   ┃結合  ┃結合  ┃結合  │個別    │個別    ┃結合  │個別   ← PMデータ
```

**セル結合が <<Start>><<End>> 行の複製で崩れる場合** → フォールバック（3.5）を使用。

### 3.5 フォールバック: 1行レイアウト

セル結合が正しく動作しない場合の代替レイアウト。全て1行で、セル結合なし。

#### ヘッダー行（1行のみ）

| A | B | C | D | E | F | G |
|---|---|---|---|---|---|---|
| `No.` | `施設名` | `氏名` | `自己負担有無 / 要介護度` | `時間` | `×日時` | `備考` |

#### AMラベル行

AMラベル行は2行レイアウトと同じ（A-G横結合で `AM`）。

#### AMデータ行（1行）

| A | B | C | D | E | F | G |
|---|---|---|---|---|---|---|
| `<<Start: ORDERBY([AM訪問], [訪問開始時間], FALSE, [作成日時], FALSE)>>` | `<<[施設名]>>` | `<<[患者名]>>` | `<<[患者自己負担有無]>>` / `<<[患者要介護度]>>` | | `<<[患者不在時間一覧]>>` | `<<[備考]>><<End>>` |

D列に自己負担有無と要介護度をスラッシュ区切りで1セルに表示する。

PMも同様（フィルタ条件を `>= "12:00:00"` に変更するだけ）。

---

## 4. テンプレートで使用する全数式

### 4.1 テンプレートタグ（Google Docsに記述する文字列）

#### ヘッダー（テーブル外）

```
<<[訪問日]>>
```

#### AM用 Start タグ（A4セルにそのまま貼り付け）

日別訪問計画のList仮想列「AM訪問」をORDERBYで訪問開始時間順にソートして展開。

```
<<Start: ORDERBY([AM訪問], [訪問開始時間], FALSE, [作成日時], FALSE)>>
```

#### PM用 Start タグ（A7セルにそのまま貼り付け）

日別訪問計画のList仮想列「PM訪問」をORDERBYで訪問開始時間順にソートして展開。

```
<<Start: ORDERBY([PM訪問], [訪問開始時間], FALSE, [作成日時], FALSE)>>
```

#### End タグ（G5, G8セルにそのまま貼り付け）

```
<<End>>
```

#### データ行で使用するタグ（各セルにそのまま貼り付け）

| セル | 貼り付ける文字列 | 出力例 |
|------|-----------------|--------|
| A上段（No.） | `<<[訪問No]>>` | 1, 2, 3... |
| B（施設名） | `<<[施設名]>>` | あさひ新琴似 |
| C（氏名） | `<<[患者名]>>` | 井川 容子 |
| D上段（自己負担有無） | `<<[患者自己負担有無]>>` | 無 / 有（2割） |
| D下段（要介護度） | `<<[患者要介護度]>>` | 要介護5 |
| E上段・E下段 | （空白のまま：手書き用） | |
| F（×日時） | `<<[患者不在時間一覧]>>` | (木) 9:30 - 10:00 |
| G上段（備考） | `<<[備考]>>` | |

### 4.2 AppSheet仮想列の計算式（全量）

テンプレートが正しく動作するために必要な仮想列の全計算式。

#### 患者不在時間テーブル

**患者名:**
```
[患者ID].[氏名]
```

**時間帯表示:**
```
IF(
  [終日フラグ],
  "終日",
  TEXT([開始時間], "HH:MM") & " - " & TEXT([終了時間], "HH:MM")
)
```

**不在時間サマリ:**
```
"(" & SUBSTITUTE([曜日リスト], ",", "・") & ") " & [時間帯表示]
```
→ 出力例: `(月・水・金) 14:00 - 15:00` / `(火) 終日`

#### 患者マスタ

**不在時間一覧（改行区切り）:**
```
SUBSTITUTE(
  CONCATENATE(
    SELECT(
      患者不在時間[不在時間サマリ],
      [患者ID] = [_THISROW].[ID]
    )
  ),
  " , ",
  CHAR(10)
)
```
→ 出力例:
```
(水) 13:30 - 16:35
(金) 12:00 - 13:00
```

#### 診療スケジュール

**訪問No（日別通し番号）:**
```
COUNT(
  SELECT(
    診療スケジュール[スケジュールID],
    AND(
      [訪問日] = [_THISROW].[訪問日],
      [ステータス] <> "キャンセル",
      OR(
        [訪問開始時間] < [_THISROW].[訪問開始時間],
        AND(
          [訪問開始時間] = [_THISROW].[訪問開始時間],
          [作成日時] < [_THISROW].[作成日時]
        )
      )
    )
  )
) + 1
```
→ 同じ訪問日の中で訪問開始時間順のAM/PM通し番号

**患者自己負担有無:**
```
[患者ID].[自己負担有無]
```

**患者要介護度:**
```
[患者ID].[要介護度]
```

**患者不在時間一覧:**
```
[患者ID].[不在時間一覧]
```

**施設名（既存）:**
```
[施設ID].[施設名]
```

**患者名（既存）:**
```
[患者ID].[氏名]
```

#### 日別訪問計画

**AM件数:**
```
COUNT(
  SELECT(
    診療スケジュール[スケジュールID],
    AND(
      [訪問日] = [_THISROW].[訪問日],
      [訪問開始時間] < "12:00:00",
      [ステータス] <> "キャンセル"
    )
  )
)
```

**PM件数:**
```
COUNT(
  SELECT(
    診療スケジュール[スケジュールID],
    AND(
      [訪問日] = [_THISROW].[訪問日],
      [訪問開始時間] >= "12:00:00",
      [ステータス] <> "キャンセル"
    )
  )
)
```

**合計件数:**
```
[AM件数] + [PM件数]
```

**スケジュール概要:**
```
TEXT([訪問日], "YYYY/MM/DD") & "（" &
SWITCH(
  WEEKDAY([訪問日]),
  1, "日", 2, "月", 3, "火", 4, "水", 5, "木", 6, "金", 7, "土"
) & "） " & [合計件数] & "件"
```
→ 出力例: `2025/01/20（月） 3件`

**AM訪問（List型）:**
```
SELECT(
  診療スケジュール[スケジュールID],
  AND(
    [訪問日] = [_THISROW].[訪問日],
    [訪問開始時間] < "12:00:00",
    [ステータス] <> "キャンセル"
  )
)
```
→ PDFテンプレートの `<<Start: ORDERBY(...)>>` で参照

**PM訪問（List型）:**
```
SELECT(
  診療スケジュール[スケジュールID],
  AND(
    [訪問日] = [_THISROW].[訪問日],
    [訪問開始時間] >= "12:00:00",
    [ステータス] <> "キャンセル"
  )
)
```
→ PDFテンプレートの `<<Start: ORDERBY(...)>>` で参照

### 4.3 テンプレートでのソート順制御

テンプレートの `<<Start>>` タグで `ORDERBY()` 関数を使用し、List仮想列を訪問開始時間順にソートして展開する。

```
<<Start: ORDERBY([AM訪問], [訪問開始時間], FALSE, [作成日時], FALSE)>>
```

- 第1ソートキー: `[訪問開始時間]` 昇順（FALSE = ASC）
- 第2ソートキー: `[作成日時]` 昇順（同時刻の場合の順序決定）
- ソート順は訪問No仮想列の計算ロジックと同じ。PDFに表示される行の並び順と訪問No列の値が一致する

---

## 5. AppSheetでの設定

### 5.1 テンプレートファイルの登録

1. AppSheet管理画面 → Settings → Content
2. 「Templates」セクション
3. 「タイムスケジュールテンプレート」のGoogle Docsファイルを指定

### 5.2 PDF生成アクションの設定（レコード追加時に自動実行）

日別訪問計画のレコードを新規追加すると、PDFが自動生成される。

| 設定項目 | 値 |
|---------|-----|
| Event | Adds only |
| Table | 日別訪問計画 |
| Do this | App: Create a new file with a template |
| Template | タイムスケジュールテンプレート |
| File name prefix | `CONCATENATE("タイムスケジュール_", TEXT([訪問日], "YYYYMMDD"))` |
| File folder path | `"タイムスケジュールPDF/"` |

### 5.3 ステータス進行アクション

| アクション名 | 条件 | 設定値 |
|-------------|------|--------|
| 印刷済みにする | `[ステータス] = "作成済み"` | `ステータス = "印刷済み"` |
| 提出済みにする | `[ステータス] = "印刷済み"` | `ステータス = "提出済み"` |

### 5.4 運用フロー

```
レコード追加（訪問日を入力して保存）
  │
  ▼ 自動でPDF生成 → ステータス: 作成済み
  │
  ▼ 「印刷済みにする」ボタン → ステータス: 印刷済み
  │
  ▼ 「提出済みにする」ボタン → ステータス: 提出済み
```

1. 訪問計画一覧で「+」からレコードを新規追加（訪問日を指定）
2. 保存と同時にPDFが自動生成され、Google Driveに保存される
3. PDFを印刷したら「印刷済みにする」ボタンを押す
4. スタッフに提出したら「提出済みにする」ボタンを押す
5. 一覧ビューのステータス列で進捗を一目で確認できる

---

## 6. 制約と対応方針

### 6.1 固定枠数（空行）

| 項目 | 内容 |
|------|------|
| 制約 | `<<Start>>` `<<End>>` はデータがある分だけ行を動的に生成する |
| 影響 | 画像のような「データなしの空行（4番、5番）」は生成されない |
| 対応 | データがある行のみ表示する。印刷後に手書きで追記が必要な場合は、テーブル下に空行を数行追加しておく |

### 6.2 AM/PM通し連番 → 解決済み

仮想列 `訪問No` を追加したため、AM/PM通しの連番が自動で振られる。
テンプレートでは `<<[訪問No]>>` を使用する。

### 6.3 セル結合の動作

| 項目 | 内容 |
|------|------|
| 制約 | `<<Start>>` `<<End>>` で行を複製する際、セル結合が保持されるかは要テスト |
| 影響 | 2行レイアウト（自己負担有無/要介護度の分割）が崩れる可能性 |
| 対応 | まず2行レイアウトでテスト。問題があれば1行レイアウト（フォールバック）に切り替え |

### 6.4 時間・所要時間列

| 項目 | 内容 |
|------|------|
| 設計意図 | 印刷後に手書きで記入する帳票として使用 |
| テンプレート | E列は空白にしておく |
| オプション | 訪問開始時間・終了時間が入力済みの場合は `<<[訪問開始時間]>>-<<[訪問終了時間]>>` で自動表示することも可能 |

---

## 7. 実装チェックリスト

### テーブル・データ
- [ ] Googleスプレッドシートに「日別訪問計画」シートを追加
- [ ] デモCSVデータをインポート（6件）
- [ ] AppSheetでテーブルを認識させる

### 仮想列
- [ ] 患者不在時間: 不在時間サマリの式を括弧付き形式に変更
- [ ] 患者マスタ: 不在時間一覧の式を改行区切りに変更
- [ ] 診療スケジュール: 訪問Noの仮想列を追加
- [ ] 診療スケジュール: 患者自己負担有無の仮想列を追加
- [ ] 診療スケジュール: 患者要介護度の仮想列を追加
- [ ] 診療スケジュール: 患者不在時間一覧の仮想列を追加
- [ ] 日別訪問計画: AM件数, PM件数, 合計件数, スケジュール概要の仮想列を追加
- [ ] 日別訪問計画: AM訪問, PM訪問のList仮想列を追加

### テンプレート
- [ ] Google Docsでテンプレートファイルを作成
- [ ] 2行レイアウト（セル結合あり）でテスト
- [ ] 問題があれば1行レイアウトにフォールバック
- [ ] AM/PMのフィルタ条件が正しく動作するか確認
- [ ] 不在時間一覧の改行表示を確認

### AppSheet設定
- [ ] PDF生成アクションを設定
- [ ] 日別訪問計画のDetailビューにボタンが表示されることを確認
- [ ] 訪問計画一覧ビューを追加
- [ ] ナビゲーションに追加

### テスト
- [ ] デモデータでPDF生成を実行
- [ ] AM/PMの分割が正しいか確認
- [ ] 不在時間一覧の表示内容を確認
- [ ] レイアウト・フォントサイズの調整
- [ ] 印刷プレビューで確認
